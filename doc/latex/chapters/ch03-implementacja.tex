\documentclass[thesis]{subfiles}

\begin{document}

\chapter{Implementacja}
\label{ch:implementacja}

W~niniejszym rozdziale przedstawiono szczegóły implementacyjne projektu, w~szczególności opisano zastosowane biblioteki i~narzędzia pomocnicze, sposób użycia aplikacji klienckiej i~aplikacji serwera, będącymi odpowiednio --- aplikacją dla~systemu dostosowującego swoją konfigurację do~konfiguracji wzorcowej i~aplikacją do~tworzenia \hyperref[sec:obraz-zmian-konfiguracji]{obrazu zmian konfiguracji} dla~systemu wzorcowego.

%------------------------------------------------------------------------------

\section{Moduły aplikacji}

Stworzona aplikacja jest \href{https://en.wikipedia.org/wiki/Command-line_interface}{aplikacją konsolową} składającą się z~dwóch zasadniczych części --- \hyperref[sec:srv-app]{serwerowej} i~\hyperref[sec:cli-app]{klienckiej} --- nazywanej w~kodzie źródłowym odpowiednio \texttt{myscm-srv} i~\texttt{myscm-cli}\footnote{\emph{myscm} to~skrót od~roboczej nazwy stworzonego oprogramowania --- \emph{My~\href{https://en.wikipedia.org/wiki/Software_configuration_management}{Software Configuration Manager}}.}. Część serwerowa jest przeznaczona do~uruchomienia na~systemie odgrywającym rolę systemu wzorcowego, a~część kliencka na~systemach, których konfiguracja ma~zostać upodobniona do~konfiguracji systemu wzorcowego. Każda z~tych części składa się z~modułów realizujących rozłączone zadania.

Wyróżnione moduły aplikacji \hyperref[sec:srv-app]{serwera}:\mynobreakpar
\begin{itemize}
	\item moduł skanujący system wzorcowy i~tworzący plik stanu, który skrótowo opisuje stan konfiguracji systemu wzorcowego --- moduł ten~wykorzystuje do~swojego działania skaner~\hyperref[sec:aide]{AIDE} (patrz rozdział~\ref{sec:aide}),
	\item moduł tworzący na~podstawie dwóch wyników skanowań systemu wzorcowego, podpisany cyfrowo \hyperref[sec:obraz-zmian-konfiguracji]{obraz zmian konfiguracji systemu wzorcowego}, będący archiwum plików dla~klienta, które później zostaje rozpakowane i~zastosowane przez aplikację kliencką\footnote{W~przypadku konfliktów zmian, administrator może na~etapie użycia aplikacji klienckiej, interaktywnie porównać oba~pliki i~zdecydować która wersja konfliktowego pliku ma~być zachowana lub~alternatywnie może wymusić nadpisanie plików.},
	\item moduł umożliwiający przegląd i~dostosowanie stworzonego wcześniej \hyperref[sec:obraz-zmian-konfiguracji]{obrazu zmian konfiguracji systemu wzorcowego} do~własnych potrzeb,
	%\item moduł udostępniający klientom stworzony obraz zmian konfiguracji systemu wzorcowego,
	\item moduł konfiguracji aplikacji serwera --- konfiguracja ta~zawiera m.in.~ustawienia numeru portu nasłuchu na~połączenia klientów, ścieżkę do~pliku konfiguracyjnego~AIDE, określającego jakie katalogi powinny być~skanowane, ścieżkę do~klucza prywatnego certyfikatu cyfrowego serwera, używanego do~podpisywania obrazów zmian konfiguracji, ścieżkę do~katalogu, w~którym są~zapisywane generowane obrazy konfiguracji~itp.
\end{itemize}

Wyróżnione moduły \hyperref[sec:cli-app]{aplikacji klienckiej}:\mynobreakpar
\begin{itemize}
	\item moduł udostępniający innym klientom stworzony przez serwer \hyperref[sec:obraz-zmian-konfiguracji]{obraz zmian konfiguracji systemu wzorcowego},
	\item moduł odbierający, weryfikujący podpis cyfrowy, rozpakowujący i~stosujący obraz zmian konfiguracji wzorcowej udostępniony przez serwer lub~przez innego klienta,
	\item moduł konfiguracji aplikacji klienta --- konfiguracja ta~zawiera m.in.~ustawienia numeru portu nasłuchiwania serwera, protokół wykorzystany do~połączenia z~serwerem, ścieżkę do~katalogu, w~którym są~zapisywane odebrane od~serwera obrazy konfiguracji~itp.
\end{itemize}

Określenia \emph{klient} i~\emph{serwer} użyte w~kontekście opisu modułów aplikacji stworzonej w~ramach niniejszej pracy nie oznaczają klasycznego modelu komunikacji klient-serwer, w~którym serwer mógłby udostępniać klientom \hyperref[sec:obraz-zmian-konfiguracji]{obraz zmian swojej konfiguracji}. Serwer należy raczej utożsamiać z~systemem, którego oprogramowanie pozwala na~tworzenie, przegląd i~dostosowanie \hyperref[sec:obraz-zmian-konfiguracji]{obrazu zmian swojej konfiguracji}, a~nie z~systemem, do~którego klienci łączą się w~celu pobrania takiego obrazu. Zadanie dystrybuowania obrazu w~przyjętym rozwiązaniu zostało przydzielone klientom, którzy poza tym, że~stosują się do~\hyperref[sec:obraz-zmian-konfiguracji]{obrazu zmian konfiguracji systemu wzorcowego} stworzonego przez serwer, to~mogą udostępniać go~innym klientom w~ramach połączenia \hrefemph{https://en.wikipedia.org/wiki/Peer-to-peer}{peer-to-peer}. Taki model komunikacji wydaje się być skalowalny, ponieważ serwer nie jest tak obciążony jak byłby, gdyby tylko on~udostępniał obraz swojej konfiguracji.

W~kolejnych dwóch rozdziałach~\ref{sec:srv-app} i~\ref{sec:cli-app} przedstawiono instrukcję obsługi aplikacji serwera i~aplikacji klienckiej. Pominięto w~nich \href{https://www.gnu.org/prep/standards/html_node/Command_002dLine-Interfaces.html}{następujące typowe} opcje, wspólne dla~obu programów:

\setlist[description]{style=nextline,font=\ttfamily}
\begin{description}
	\item[-h, --help] Wypisuje pomoc w~języku angielskim z~informacjami o~dozwolonych opcjach aplikacji i~ich znaczeniu.
	\item[-v, --verbose] Włącza tryb ,,gadatliwy", tzn.~włącza wypisywanie dodatkowych komunikatów mogących okazać się pomocnymi przy diagnozowaniu ewentualnych problemów z~działaniem programu.
	\item[--version] Wypisuje informację o~wersji i~licencji aplikacji.
\end{description}

Zarówno aplikacji serwera jak i~aplikacji klienckiej towarzyszą skrypty i~konfiguracje pomocnicze, które obsługują m.in.~ładowanie aplikacji jako \glslink{daemon}{daemonów} uruchamianych przez menadżer usług \hreftt{https://en.wikipedia.org/wiki/Systemd}{systemd}, obsługę zależności pakietu oprogramowania, w~ramach którego zainstalowano aplikację~itp.

%------------------------------------------------------------------------------

\section{Aplikacja serwera}
\label{sec:srv-app}

\newcommand{\srvappname}{myscm-srv}
\newcommand{\myscmsrvconfig}{\path{/etc/myscm-srv/myscm-srv.conf}}

Aplikacja serwera to~aplikacja przeznaczona do~użycia z~uprawnieniami \hreftt{https://en.wikipedia.org/wiki/Superuser}{root}\footnote{Uprawnienia administratora są~konieczne do~uruchomienia skanowania~\hyperref[sec:aide]{AIDE}.} na~maszynie będącej wzorcem oprogramowania dla~klientów. Służy ona wyłącznie do~stworzenia, przeglądu i~dostosowania obrazu zmian konfiguracji przeprowadzonych przez administratora komputerowego od~czasu wybranego skanowania~(por.~krok~\hyperlink{itm:stworzenie-obrazu-konfiguracji}{3} w~rozdziale~\ref{sec:tworzenie-obrazu-konfiguracji}).

Główną funkcjonalnością aplikacji serwera jest stworzenie obrazu zmian konfiguracji, a~nie jego udostępnienie, ponieważ utworzony przez serwer obraz zmian jest udostępniany klientom przez innych klientów lub~równie dobrze może być przesłany klientowi w~dowolny inny sposób --- np.~z~wykorzystaniem protokołu \href{https://en.wikipedia.org/wiki/SSH_File_Transfer_Protocol}{SFTP}~(\emph{SSH File Transfer Protocol}) lub~\href{https://en.wikipedia.org/wiki/File_Transfer_Protocol}{FTP}~(\emph{File Transfer Protocol}), które wspiera \hyperref[sec:cli-app]{aplikacja kliencka}, a~ponadto ma~ona możliwość załadowania obrazu zmian konfiguracji z~wybranego pliku obrazu konfiguracji.

Szczegółowa instrukcja obsługi użycia aplikacji serwera została dostarczona z~przygotowanym pakietem oprogramowania \texttt{\srvappname}~(patrz załącznik~\ref{ch:cd-appendix}). Instrukcję można otworzyć po~zainstalowaniu pakietu \texttt{\srvappname} za~pomocą komendy \texttt{man~\srvappname}. Konfiguracja aplikacji serwera znajduje się w~pliku \myscmsrvconfig.

\begin{lstlisting}[language=,label=lst:myscm-srv-usage,numbers=none,caption={Szablon uruchomienia aplikacji serwera \texttt{myscm-srv} przeznaczonej do~użycia na~systemie odgrywającym rolę stacji z~konfiguracją wzorcową dla~klientów}]
myscm-srv [OPCJE]
\end{lstlisting}

Listing~\ref{lst:myscm-srv-usage} przedstawia skrócony szablon użycia aplikacji serwera, gdzie argumenty opcji ujęte w~nawiasy kwadratowe \texttt{[~]} oznaczają opcjonalność tych argumentów\footnote{Użycie argumentów opcjonalnych, które mają swoje odpowiedniki w~pliku konfiguracyjnym, powoduje zignorowanie ustawień odpowiedników z~pliku konfiguracyjnego --- dotyczy to~zarówno \hyperref[sec:srv-app]{aplikacji serwera}, jak i~\hyperref[sec:cli-app]{aplikacji klienckiej}.}, a~\texttt{OPCJE} oznaczają następujące dozwolone opcje:\mynobreakpar

\begin{description}
	\item[-s, --scan {[SCAN\_OUT\_FILE]}]\hypertarget{itm:srv-scan} Skanuje system wzorcowy za~pomocą skanera \hyperref[sec:aide]{AIDE} korzystając z~pliku konfiguracyjnego~AIDE, wskazywanego przez plik konfiguracyjny aplikacji serwera. Jeśli parametr opcjonalny \texttt{SCAN\_OUT\_FILE} został podany, to~jest on~traktowany jako miejsce zapisu wyniku skanowania. W~przeciwnym wypadku wynik skanowania zostaje zapisany w~pliku ustawionym w~konfiguracji aplikacji --- domyślnie jest to~plik tekstowy \path{/var/lib/myscm-srv/aide.db.X}, gdzie \texttt{X} to~liczba naturalna\footnote{Zakładamy, że~$0\in\mathbb{N}$.} oznaczająca liczbę skanowań dokonanych do~tej pory.
	\item[-g, --gen-img {CLIENT\_STATE\_FILE}]\hypertarget{itm:srv-gen-img} Tworzy \hyperref[sec:obraz-zmian-konfiguracji]{obraz zmian konfiguracji systemu wzorcowego} na~podstawie dwóch plików stanów stworzonych w~następstwie wywołania programu serwera z~opcją \hyperlink{itm:srv-scan}{\texttt{--scan}} --- pliku stanu \texttt{CLIENT\_STATE\_FILE} określającego deklarowany przez klienta aktualny stan jego konfiguracji i~najnowszego dostępnego pliku stanu, tzn.~pliku \path{/var/lib/myscm-srv/aide.db.X} z~największą liczbą~\texttt{X}. Obraz zmian konfiguracji to~archiwum\footnote{Rodzaj użytej kompresji jest konfigurowalny. Domyślnie plik obrazu konfiguracji jest skompresowany za~pomocą \hreftt{https://en.wikipedia.org/wiki/Tar_(computing)}{tar} i~\hreftt{https://en.wikipedia.org/wiki/Gzip}{gzip} do~pliku archiwum z~rozszerzeniem \texttt{tar.gz}.}, które zostaje zapisane w~pliku \path{/var/lib/myscm-srv/myscm-img.A.B.tar.gz}, gdzie \texttt{A} i~\texttt{B} to~liczba \texttt{X} w~nazwie pliku stanu \path{/var/lib/myscm-srv/aide.db.X} odpowiadającego odpowiednio --- aktualnemu stanowi konfiguracji klienta i~stanowi do~którego klient chce aktualizować swoją konfigurację. Jeśli obraz konfiguracji o~tej samej nazwie już istnieje, to~zostaje nadpisany. Jeśli najnowszy plik stanu jest nieaktualny, tzn.~w~systemie wzorcowym zaszły zmiany w~obrębie śledzonych plików po~dokonaniu ostatniego skanowania za~pomocą opcji \hyperlink{itm:srv-scan}{\texttt{--scan}}, to~program wykryje taką sytuację nie dopuszczając do~wygenerowania obrazu dopóki nie zostanie uruchomione ponowne skanowanie systemu wzorcowego i~spyta użytkownika czy~wymusić ponowne skanowanie.
	\item[--upgrade {CLIENT\_STATE\_FILE}] Wykonuje program tak, jakby był wywołany najpierw z~opcją \hyperlink{itm:srv-scan}{\texttt{--scan}} bez dodatkowych parametrów, a~następnie z~opcją \hyperlink{itm:srv-gen-img}{\texttt{--gen-img}} z~parametrem \texttt{CLIENT\_STATE\_FILE}.
	\item[-c, --config CONFIG\_FILE] Domyślnie konfiguracja aplikacji serwera jest czytana z~pliku tekstowego \myscmsrvconfig. Ta~opcja zmienia to~zachowanie wczytując konfigurację aplikacji serwera z~pliku tekstowego \texttt{CONFIG\_FILE}.
	\item[-s, --share]\hypertarget{itm:srv-share} Włącza udostępnianie obrazów konfiguracji utworzonych za~pomocą opcji \hyperlink{itm:srv-gen-img}{\texttt{--gen-img}} na~porcie określonym przez konfigurację serwera lub~na~porcie \texttt{PORT\_NUMBER} określonym przez opcję \hyperlink{itm:srv-port}{\texttt{--port}}.
	\item[-p, --port PORT\_NUMBER]\hypertarget{itm:port} Ustawia port nasłuchu na~klientów na~\texttt{PORT\_NUMBER}. Ta~opcja ma~sens tylko w~połączeniu z~opcją \hyperlink{itm:srv-share}{\texttt{--share}} i~zostaje ona zignorowana w~przypadku jej~braku.
	%\item[--force]
	\item[-d, --daemonize {[TIME\_INTERVAL]}] Uruchamia aplikację w~tle i~włącza cykliczne skanowanie systemu co~pewien czas ustawiony w~konfiguracji serwera lub~co~czas \texttt{TIME\_INTERVAL} wyrażony w~minutach. Opcja ta~może być łączona m.in.~z~opcją \hyperlink{itm:srv-share}{\texttt{--share}}. Wszystkie komunikaty programu zostają przekierowane do~\hreftt{https://en.wikipedia.org/wiki/Syslog}{sysloga} lub~do~pliku z~logami, zdefiniowanym w~konfiguracji aplikacji serwera.
\end{description}

%------------------------------------------------------------------------------

\section{Aplikacja kliencka}
\label{sec:cli-app}

\newcommand{\cliappname}{myscm-cli}
\newcommand{\myscmcliconfig}{\path{/etc/myscm-cli/myscm-cli.conf}}

Aplikacja kliencka to~aplikacja przeznaczona do~użycia z~uprawnieniami \hreftt{https://en.wikipedia.org/wiki/Superuser}{root}\footnote{Uprawnienia administratora są~konieczne do~tworzenia, zmiany i~usuwania plików z~dowolnej części systemu plików, co~jest konieczne podczas zastosowania obrazu zmian konfiguracji systemu wzorcowego.} na~maszynie, której konfigurację administrator chce dostosować do~konfiguracji systemu wzorcowego. Aplikacja kliencka umożliwia pobranie obrazu zmian konfiguracji od~innego klienta za~pomocą \href{https://en.wikipedia.org/wiki/SSH_File_Transfer_Protocol}{SFTP}~(\emph{SSH File Transfer Protocol}), \href{https://en.wikipedia.org/wiki/File_Transfer_Protocol}{FTP} lub~własnego protokołu, a~następnie umożliwia zastosowanie~go na~systemie klienckim.

Szczegółowa instrukcja obsługi użycia aplikacji klienckiej, analogicznie jak w~przypadku aplikacji serwera, została dostarczona z~przygotowanym pakietem oprogramowania \texttt{\cliappname}~(patrz załącznik~\ref{ch:cd-appendix}). Instrukcję można otworzyć po~zainstalowaniu pakietu \texttt{\cliappname} za~pomocą komendy \texttt{man~\cliappname}. Konfiguracja aplikacji klienckiej znajduje się w~pliku \myscmcliconfig.

\begin{lstlisting}[numbers=none,language=,caption={Szablon uruchomienia aplikacji klienckiej \texttt{myscm-cli} dostosowującej konfigurację systemu klienta do~konfiguracji pobranej z~serwera z~IP \texttt{server\_IP} lub~z~pliku {\hyperref[sec:obraz-zmian-konfiguracji]{obrazu zmian konfiguracji systemu wzorcowego}} określonego ścieżką~\texttt{myscm\_img\_file}},label=lst:myscm-cli-usage]
myscm-cli [OPCJE] [server_IP | myscm_img_file]
\end{lstlisting}

Listing~\ref{lst:myscm-cli-usage} przedstawia skrócony szablon użycia aplikacji klienckiej, gdzie argumenty opcji ujęte w~nawiasy kwadratowe \texttt{[~]} oznaczają opcjonalność tych argumentów, a~\texttt{OPCJE} oznaczają następujące dozwolone opcje:\mynobreakpar

\begin{description}
	\item[--update {MYSCM\_CURRENT\_STATE}]\hypertarget{itm:cli-update} Pobiera obraz zmian konfiguracji systemu z~serwera zdefiniowanego w~konfiguracji aplikacji klienckiej lub, jeśli \texttt{\hyperref[lst:myscm-cli-usage]{server\_IP}} został podany w~wywołaniu programu, z~serwera o~adresie \texttt{server\_IP}, a~następnie sprawdza poprawność certyfikatu cyfrowego, którym jest podpisany i~\emph{nie} stosuje jej~na~systemie klienta. Do~połączenia z~serwerem zostaje wykorzystany protokół zdefiniowany w~konfiguracji klienta, chyba, że~jest obecna opcja \hyperlink{itm:cli-sftp}{\texttt{--SFTP}} lub~\hyperlink{itm:cli-sftp}{\texttt{--FTP}} wymuszająca któryś z~tych protokołów. Pobrany obraz zmian zostaje zapisany do~pliku określonego przez konfigurację aplikacji --- domyślnie do~\path{/var/myscm-cli/myscm-img.A.B.tar.gz}, gdzie \texttt{A} i~\texttt{B}~to~liczba naturalna identyfikująca odpowiednio --- aktualną i~docelową wersję obrazu zmian. W~przypadku gdy w~wywołaniu programu zamiast adresu~IP serwera podano ścieżkę \texttt{\hyperref[lst:myscm-cli-usage]{myscm\_img\_file}}, to~obraz zmian konfiguracji nie jest pobierany z~serwera, tylko zostaje odczytany z~pliku o~zadanej ścieżce. Parametr \texttt{MYSCM\_CURRENT\_STATE} określa liczbę naturalną \texttt{B}~w~nazwie ostatnio zastosowanego przez klienta obrazu zmian \path{/var/myscm-cli/myscm-img.A.B.tar.gz}.
	\item[--apply-img {[MYSCM\_IMG\_FILE]}]\hypertarget{itm:cli-apply-img} Zastosowuje ostatnio wygenerowany obraz konfiguracji systemu załadowany z~pliku \path{MYSCM_IMG_FILE} lub, jeśli parametr ten nie został podany, z pliku którego ścieżka jest ustawiona w~konfiguracji aplikacji --- domyślnie z~pliku \path{/var/myscm-cli/myscm-img.A.B.tar.gz} z~największą liczbą~\texttt{B}. Jeśli system klienta nie jest w~stanie~\texttt{A}, to~aplikacja kliencka wyświetli ostrzeżenie i~informacje o różnicach w~oczekiwanej i~podanej konfiguracji systemu. Jeśli podczas zastosowania obrazu konfiguracji systemu pojawią się konflikty, to~aplikacja umożliwia administratorowi porównać konfliktowe pliki i~rozwiązać konflikty za~pomocą ustawionego w~konfiguracji aplikacji narzędzia --- \href{https://developer.atlassian.com/blog/2015/12/tips-tools-to-solve-git-conflicts/}{np.}~za~pomocą \hrefemph{http://kdiff3.sourceforge.net/}{kdiff3}, \hrefemph{http://vimdoc.sourceforge.net/htmldoc/diff.html}{vimdiff}, \hrefemph{http://meldmerge.org/}{meld}~itp.
	\item[--upgrade {MYSCM\_CURRENT\_STATE}]\hypertarget{itm:cli-upgrade} Wykonuje program tak, jakby był wywołany najpierw z~opcją \hyperlink{itm:cli-update}{\texttt{--update}} z~parametrem \texttt{MYSCM\_CURRENT\_STATE}, a~następnie z~opcją \hyperlink{itm:cli-apply-img}{\texttt{--apply-img}} bez~dodatkowych parametrów. W~przypadku obecności w~wywołaniu programu opcjonalnego adresu IP~serwera \texttt{server\_IP} lub~ścieżki do~pliku obrazu \texttt{myscm\_img\_file}, zastosowany obraz zmian konfiguracji pochodzi odpowiednio --- z~serwera o~zadanym adresie~IP bądź z~pliku o~zadanej ścieżce.
	\item[--SFTP, --FTP]\hypertarget{itm:cli-sftp} Wymusza zastosowanie protokołu (S)FTP do~połączenia z~serwerem. Dane połączenia takie jak np.~nazwa użytkownika, hasło i~port są~pobierane z~konfiguracji aplikacji.
	\item[--cert X509\_CERT\_FILE] Sprawdza poprawność obrazu konfiguracji za~pomocą certyfikatu cyfrowego \href{https://en.wikipedia.org/wiki/X.509}{X.509} zapisanego w~formacie \href{https://en.wikipedia.org/wiki/Privacy-enhanced_Electronic_Mail}{PEM}\footnote{Format \emph{Privacy-enhanced Electronic Mail} został sformalizowany przez \gls{ietf} w~2015~roku w~\href{https://tools.ietf.org/html/rfc7468}{RFC7468}.} w~pliku określonego ścieżką \path{X509_CERT_FILE}. Jeśli opcja nie zostanie podana, to~domyślnie używany certyfikat cyfrowy jest ustawiony w~konfiguracji aplikacji.
	\item[--force]\hypertarget{itm:cli-force} Wymusza nadpisanie plików i~ich~atrybutów na~systemie klienta w~przypadku zaistnienia konfliktów podczas zastosowania obrazu systemu. Ta~opcja ma~sens tylko w~połączeniu z~opcją \hyperlink{itm:cli-upgrade}{\texttt{--upgrade}} lub~\hyperlink{itm:cli-apply-img}{\texttt{--apply-img}} --- w~przeciwnym wypadku jest ignorowana.
	\item[-p, --port PORT\_NUMBER] Wymusza połączenie do~serwera na~porcie \texttt{PORT\_NUMBER} za~pomocą protokołu określonego w~konfiguracji aplikacji klienckiej lub~za~pomocą protokołu określonego flagą \hyperlink{itm:cli-sftp}{\texttt{--SFTP}} lub~\hyperlink{itm:cli-sftp}{\texttt{--FTP}}.
	\item[-d, --daemonize {[TIME\_INTERVAL]}] Uruchamia aplikację w~tle i~włącza cykliczny \hyperlink{itm:cli-upgrade}{\texttt{--upgrade}} systemu. Czas odstępu między kolejnymi aktualizacjami jest ustawiony w~konfiguracji aplikacji klienckiej lub~w~opcjonalnym parametrze \texttt{TIME\_INTERVAL} wyrażonym w~minutach. Wszystkie komunikaty programu zostają przekierowane do~\hreftt{https://en.wikipedia.org/wiki/Syslog}{sysloga} lub~do~pliku z~logami, zdefiniowanym w~konfiguracji aplikacji serwera.
\end{description}

%------------------------------------------------------------------------------

\section{Kod źródłowy}

Kod źródłowy projektu został w~całości napisany w~języku \href{https://en.wikipedia.org/wiki/Python_(programming_language)}{Python} w~najnowszej dostępnej w~trakcie pisania tej pracy wersji~3.6.1. Źródła projektu znajdują się na~płycie~CD dołączonej do~tej pracy (patrz załącznik~\ref{ch:cd-appendix}) w~katalogu~\path{/src}, a~dokumentacja wygenerowana z~komentarzy kodu źródłowego w~\path{/doc/python}.

Kod źródłowy został sformatowany zgodnie z~wymogami \href{https://www.python.org/dev/peps/pep-0008/}{PEP~8} (\emph{Python Enhancement Proposals}) pt.~\emph{Style Guide for Python Code} i~\href{https://www.python.org/dev/peps/pep-0257/}{PEP~257} pt.~\emph{Docstring Conventions}. Do~sprawdzenia zgodności napisanego kodu ze~standardem~PEP~8 wykorzystano narzędzie \hreftt{https://pypi.python.org/pypi/flake8}{flake8}, który obudowuje (\emph{wrapper}) narzędzia \hreftt{https://pypi.python.org/pypi/pep8}{pep8}, \hreftt{https://pypi.python.org/pypi/pyflakes}{pyflakes}, \hreftt{https://pypi.python.org/pypi/pycodestyle}{pycodestyle} i~\hreftt{https://pypi.python.org/pypi/mccabe}{mccabe}. Edytorem kodu wykorzystanym do~implementacji był \texttt{vim} rozbudowany o~\href{http://vimawesome.com/}{wtyczki}~(\emph{plugins}).

Aplikacja serwera i~aplikacja kliencka nie są~zależne od~żadnej konkretnej dystrybucji \glslink{gnulinux}{GNU/Linux}, dlatego zasadniczo powinny one~działać niemal na~każdej dystrybucji z~zainstalowanym Pythonem w~wersji~3 i~oprogramowaniem wymienionym w~rozdziale~\ref{sec:wykorzystane-oprogramowanie}. Jak~wspomniano w~rozdziale~\ref{sec:obraz-zmian-konfiguracji}, najbezpieczniej dla~poprawności działania obu aplikacji jest wtedy, gdy~aplikacja kliencka korzysta z~obrazów konfiguracji systemu przygotowanego na~maszynie serwera z~tą samą dystrybucją \glslink{gnulinux}{GNU/Linux}, którą ma~klient\footnote{Wymaganie to~można złagodzić w~niektórych przypadkach pokrewnych dystrybucji z~tym samym schematem drzewa katalogów, pochodzących od~tej~samej dystrybucji, np.~\href{https://en.wikipedia.org/wiki/Debian}{Debian}.}. Wymaganie to~wynika m.in.~z~tego, że~różne dystrybucje mają czasami różne schematy drzewa katalogów. Jednym z~\href{https://en.wikipedia.org/wiki/Filesystem_Hierarchy_Standard#FHS_compliance}{wielu} przykładów niezgodności są~katalogi \path{/bin} i~\path{/usr/bin}, które w~niektórych dystrybucjach istnieją oba (np.~Debian), w~innych też istnieją oba, przy czym \path{/bin} jest dowiązaniem symbolicznym do~\path{/usr/bin}, a~w~pozostałych istnieje tylko jeden z~tych katalogów. Drugim zastrzeżeniem jest to,~że jeśli w~obrazie wzorcowym są~zawarte skompilowane programy lub~biblioteki, to~serwer przygotowujący obraz konfiguracji dla~klienta musi mieć tę~samą architekturę procesora\footnote{Architektura procesora, czyli w~skrócie ISA (\emph{Instruction Set Architecture}). Przykładowe architektury procesorów to~\href{https://en.wikipedia.org/wiki/List_of_instruction_sets}{np.}~\href{https://en.wikipedia.org/wiki/X86-64}{AMD64}, \href{https://en.wikipedia.org/wiki/X86}{x86}, \href{https://en.wikipedia.org/wiki/ARM_architecture}{ARM}, \href{https://en.wikipedia.org/wiki/IA-64}{IA-64}, \href{https://en.wikipedia.org/wiki/PowerPC}{PowerPC} \href{https://en.wikipedia.org/wiki/Nios_II}{Nios~II}.} co~klient --- programy skompilowane dla~jednej architektury co~do~zasady\footnote{Chyba, że~architektura procesora klienta i~serwera są~\href{https://en.wikipedia.org/wiki/X86-64\#OPMODES}{kompatybilne}.} nie uruchomią się na~innej architekturze.

%------------------------------------------------------------------------------

\section{Wykorzystane biblioteki}
\label{sec:wykorzystane-oprogramowanie}

Do~implementacji projektu wykorzystano kilkadziesiąt \href{https://docs.python.org/dev/tutorial/modules.html}{modułów} Pythona\footnote{W~tym m.in.:~\hreftt{https://pypi.python.org/pypi/distro}{distro}, \hreftt{https://docs.python.org/dev/library/configparser.html}{configparser}, \hreftt{https://docs.python.org/dev/library/argparse.html}{argparse}, \hreftt{https://pypi.python.org/pypi/argcomplete}{argcomplete}, \hreftt{http://pyyaml.org/wiki/PyYAMLDocumentation}{pyyaml}, \hreftt{https://pypi.python.org/pypi/pyOpenSSL}{pyOpenSSL}, \hreftt{https://pypi.python.org/pypi/colorlog}{colorlog} i~wiele innych.}, kilka pomocniczych aplikacji i~bibliotek. Wyróżnione z~nich~to:\mynobreakpar
\begin{itemize}
	\item \href{http://aide.sourceforge.net/}{AIDE} (\emph{Advanced Intrusion Detection Environment}) --- skaner integralności plików zaprojektowany w~celu wykrywania złośliwego oprogramowania, np.~\hrefemph{https://en.wikipedia.org/wiki/Rootkit}{rootkitów}. W~niniejszym projekcie został wykorzystany do~wykrywania zmian w~konfiguracji systemu wzorcowego (patrz rozdział~\ref{sec:aide}).
	\item \href{http://www.pyopenssl.org/}{pyOpenSSL} --- \hrefemph{https://en.wikipedia.org/wiki/Language_binding}{Binding} dla~biblioteki OpenSSL. Biblioteka ta~implementuje wiele protokołów i~algorytmów kryptograficznych, ale~w~ramach projektu została wykorzystana tylko w~celu umożliwia uwierzytelnienie serwera przez klienta przez użycie certyfikatów cyfrowych.
%\gls{openssl} udostępnia wiele metod i~algorytmów kryptograficznych, które przetrwały wiele lat kryptoanaliz (np.~\gls{aes}, \gls{rsa}) i~są powszechnie uważane za~bezpieczne, pod~warunkiem poprawnego ich~wykorzystania i~zastosowania kluczy o~odpowiednio dużej długości. Wykorzystanie tej biblioteki w~kontekście komunikacji między klientem i~serwerem zostało opisane w~rozdziale~\ref{sec:security}, dotyczącym bezpieczeństwa opracowanego protokołu.
%	\item \hreftt{http://pyyaml.org/}{PyYAML} --- Służy do~parsowania plików konfiguracyjnych \texttt{YAML} serwera i~klienta.
\end{itemize}

%------------------------------------------------------------------------------

\section{AIDE}
\label{sec:aide}

Jednym z~głównych narzędzi wykorzystanych do~implementacji projektu jest~\href{http://aide.sourceforge.net/}{AIDE}~(\emph{Advanced Intrusion Detection Environment}). \href{https://wiki.archlinux.org/index.php/AIDE}{AIDE}~jest oprogramowaniem zaprojektowanym z~myślą wykrywania zmian w~systemie plików w~celu wykrycia złoźliwego oprogramowania\footnote{Taki rodzaj oprogramowania jest nazywany oprogramowaniem~\href{https://en.wikipedia.org/wiki/Host-based_intrusion_detection_system_comparison}{HIDS}~(\hrefemph{https://wiki.archlinux.org/index.php/List_of_applications/Security\#Threat_and_vulnerability_detection}{Host-based Intrusion Detection System}).}, jednak sposób jego działania nie ogranicza wykorzystania go~tylko do~tego celu. AIDE~został zapoczątkowany w~1999~roku przez dwóch Finów --- \href{http://www.ipi.fi/~rammer/cv.html}{Ramiego Lehtiego}\footnote{\href{http://www.ipi.fi/~rammer/cv.html}{Będącego} w~latach 1996--1999 administratorem komputerowym w~\href{http://www.tut.fi/en}{Tampere University of~Technology~(TUT)} w~Finlandii.} oraz~\href{https://www.linkedin.com/in/pablo-virolainen-73501731/}{Pablo Virolainena} --- jest w~całości napisany w~języku~\href{https://en.wikipedia.org/wiki/C_(programming_language)}{C} i~jest objęty \glslink{gpl}{licencją~GPL}.

Działanie AIDE polega na~wykonywaniu migawek systemu~(\emph{system snapshot}) zawierających, w~zależności od~konfiguracji, np.~czas modyfikacji śledzonych plików, ilość zajmowanego przez nie miejsca, uprawnienia do~nich i~inne atrybuty plików, zdefiniowane przez administratora w~konfiguracji \href{https://linux.die.net/man/5/aide.conf}{\path{/etc/aide/aide.conf}}. Konfiguracja ta~jest zapisana w~formacie podobnym do~formatu użytego w~komercyjnym oprogramowaniu \href{https://en.wikipedia.org/wiki/Open_Source_Tripwire}{Tripwire}, stworzonym w~1992~roku przez \href{https://en.wikipedia.org/wiki/Gene_Spafford}{prof.~Gene Spafforda} z~\href{https://en.wikipedia.org/wiki/Purdue_University}{Purdue University}~(USA, \href{https://en.wikipedia.org/wiki/Indiana}{Indiana}) i~jego studenta \href{https://en.wikipedia.org/wiki/Gene_Kim}{Gene Kima}. Duże podobieństwo między konfiguracją AIDE i~Tripwire, o~którym wspomina instrukcja obsługi (\emph{\gls{manual}}) pliku konfiguracyjnego \hreftt{https://linux.die.net/man/5/aide.conf}{aide.conf}, jest przesłanką do~przypuszczenia, że~komercyjny Tripwire mógł być~pierwowzorem dla~\glslink{wolne-oprogramowanie}{otwartoźródłowego} AIDE. Nowe, znacznie rozbudowane wersje oprogramowania Tripwire są~sprzedawane do~dziś w~ramach działalności \href{https://en.wikipedia.org/wiki/Tripwire_(company)}{firmy} o~tej samej nazwie.

W~klasycznym zastosowaniu AIDE związanym z~zapewnieniem bezpieczeństwa systemowi operacyjnemu przez zagwarantowanie jego integralności, pierwsza, referencyjna migawka utworzona komendą \hreftt{https://linux.die.net/man/1/aide}{aide --init}, powinna zostać wykonana na~dopiero~co zainstalowanym systemie operacyjnym przed podłączeniem go~do~sieci i~zapisana na~systemie plików tylko do~odczytu~(\emph{read-only}) lub~na~nośniku niepodłączonym do~działającego systemu (\hrefemph{https://www.techopedia.com/definition/30275/cold-storage}{cold storage})\footnote{Instrukcja użytkownika (\emph{\gls{manual}}) AIDE \href{http://aide.sourceforge.net/stable/manual.html\#usage}{zaleca} przeniesienie na~bezpieczne nośniki również binaria, konfigurację i~instrukcję ~AIDE~\cite{aide-manual}.}~\cite{aide-manual}. Pierwsza migawka jest referencyjnym stanem systemu, do~którego będą porównywane kolejne migawki, a~zapisanie jej~na~partycji \href{https://linux.die.net/man/8/mount}{zamontowanej} w~trybie tylko do~odczytu i~umieszczenie jej~na~bezpiecznym nośniku danych minimalizuje ryzyko jej modyfikacji z~jakiegokolwiek powodu --- np.~z~powodu złośliwego oprogramowania, awarii, przypadkowego nadpisania~itd. Migawki wykonane podczas kolejnych skanowań, wykonane komendą \hreftt{https://linux.die.net/man/1/aide}{aide~--check}, są~porównywane z~referencyjną migawką i~na~tej podstawie AIDE~tworzy tekstowy raport zmian, który zostaje odczytany i~interpretowany przez oprogramowanie stworzone w~ramach niniejszej pracy, aby~na tej~podstawie wygenerować \hyperref[sec:obraz-zmian-konfiguracji]{obraz zmian konfiguracji systemu wzorcowego}. Pierwszą migawkę referencyjną można zastąpić nową uruchamiając AIDE z~flagą \hreftt{https://linux.die.net/man/1/aide}{--update} i~nadpisując istniejący plik (domyślnie) \path{/var/lib/aide/aide.db} nowym plikiem \path{/var/lib/aide/aide.db.new} --- taka aktualizacja bazy AIDE jest szczególnie użyteczna przy iteracyjnym dostosowywaniu konfiguracji AIDE \path{/etc/aide/aide.conf} do~własnych potrzeb.

W~drzewie katalogów systemów \glslink{unix-like-system}{*niksowych}\footnote{Struktura drzewa katalogów systemów \glslink{unix-like-system}{*niksowych} jest zdefiniowana przez \hrefemph{https://wiki.linuxfoundation.org/lsb/fhs}{Filesystem Hierarchy Standard}~(\href{http://www.tldp.org/LDP/sag/html/fs-background.html}{FHS}).} istnieją katalogi systemowe, tzn.~katalogi niebędące katalogiem domowym użytkownika ani jego podkatalogiem, których zawartość zmienia się np.~co~każde uruchomienie systemu i~takie zachowanie nie powinno zazwyczaj niepokoić administratora komputerowego, dlatego powinny być one (i~część z~nich jest domyślnie) wyłączone ze~skanowania~AIDE. Do~takich katalogów należą~m.in.~katalogi:\mynobreakpar

\begin{itemize}
	\item \hreftt{http://www.tldp.org/LDP/sag/html/var-fs.html}{/var} --- katalog, w~którym znajdują się \href{http://www.linuxpl.org/SAG/x547.html}{m.in.}~logi w~\path{/var/log}, blokady plików w~\path{/var/lock}, \emph{cache} w~\path{/var/cache}, \href{http://www.tldp.org/HOWTO/Printing-Usage-HOWTO-2.html}{kolejki wydruku} i~kolejki pocztowe w~\path{/var/spool}~itp.,
	\item \hreftt{http://www.tldp.org/LDP/Linux-Filesystem-Hierarchy/html/tmp.html}{/tmp} --- katalog z~danymi tymczasowymi programów.
\end{itemize}

 Do~katalogów, które również powinny być wyłączone ze~skanowania AIDE należą katalogi specjalne, w~tym m.in.~katalogi wirtualne, których istnienie zapewnia w~locie (\emph{on the fly}) \glslink{kernel}{jądro} systemu operacyjnego:\mynobreakpar

\begin{itemize}
	\item \hreftt{https://www.kernel.org/doc/Documentation/filesystems/sysfs.txt}{/sys} --- katalog zawierający m.in.~informacje o~podłączonych urządzeniach,
	\item \hreftt{http://www.tldp.org/LDP/sag/html/proc-fs.html}{/proc} --- katalog \hreftt{https://en.wikipedia.org/wiki/Procfs}{procfs}, zawierający informacje o~działających procesach,
	\item \hreftt{http://www.tldp.org/LDP/sag/html/dev-fs.html}{/dev} --- katalog zawierający \href{https://en.wikipedia.org/wiki/Device_file}{pliki urządzeń}, będące interfejsami sterowników urządzeń,
	\item \hreftt{https://unix.stackexchange.com/questions/13972/what-is-this-new-run-filesystem/13973}{/run} --- katalog zawierający dane dotyczące np.~aktualnie zalogowanych użytkowników i~działających \glslink{daemon}{daemonów} --- często montowany w~systemie plików \hreftt{https://wiki.archlinux.org/index.php/Tmpfs}{tmpfs}.
	\item \hreftt{http://www.tldp.org/LDP/Linux-Filesystem-Hierarchy/html/media.html}{/media} --- miejsce montowania tymczasowo podłączonych nośników danych (\emph{removable media}),
	\item \hreftt{http://www.tldp.org/LDP/Linux-Filesystem-Hierarchy/html/mnt.html}{/mnt} --- miejsce tymczasowego montowania systemów plików.
\end{itemize}

\begin{lstlisting}[language=,caption={Zawartość pliku \protect\path{/etc/aide/aide.conf} z~przykładową konfiguracją~AIDE\\ (przykład z~oficjalnej strony internetowej projektu \hreftt{http://aide.sourceforge.net/stable/manual.html}{aide.sourceforge.net/stable/manual.html})},label=lst:aide-config,escapechar=|]
MyRule = p+i+n+u+g+s+b+m+c+md5+sha1|\label{line:custom-rule}|
/etc p+i+u+g     # check only permissions, inode, user and group for etc|\label{line:etc-conf}|
/bin MyRule      # apply the custom rule to the files in bin|\label{line:bin-conf}|
/sbin MyRule     # apply the same custom rule to the files in sbin|\label{line:sbin-conf}|
/var MyRule|\label{line:var-conf}|
!/var/log/.*     # ignore the log dir it changes too often|\label{line:var-log}|
!/var/spool/.*   # ignore spool dirs as they change too often|\label{line:spool}|
!/var/adm/utmp$  # ignore the file /var/adm/utmp|\label{line:var-adm-utmp}|
\end{lstlisting}

Listing~\ref{lst:aide-config} przedstawia przykładową konfigurację~AIDE. W~\hyperref[line:custom-rule]{pierwszej linii listingu} została zdefiniowana reguła, która określa jakie atrybuty śledzonego pliku lub~katalogu definiują jego stan (poza zawartością). W~tym przykładzie są~to: \href{https://www.linux.com/learn/understanding-linux-file-permissions}{uprawnienia do~pliku}~(\texttt{p}), \href{https://en.wikipedia.org/wiki/Inode}{i-węzeł}~(\texttt{i}), liczba \href{https://en.wikipedia.org/wiki/Hard_link}{dowiązań twardych}~(\texttt{n}), nazwa użytkownika~(\texttt{u}), nazwa grupy~(\texttt{g}), wielkość pliku~(\texttt{s}), liczba zajmowanych \href{https://en.wikipedia.org/wiki/Block_\%28data_storage\%29}{bloków pamięci}\footnote{Rozmiar bloku pamięci np.~partycji \texttt{sda1} można wyświetlić wyrażony w~bajtach za~pomocą komendy \texttt{blockdev --getbsz /dev/sda1}. Domyślna, typowa wartość rozmiaru bloku pamięci waha się w~zależności m.in.~od~zastosowanego systemu plików --- najczęściej wynoszą one~4096, 2048 lub~1024~bajty.}~(\texttt{b}), czas modyfikacji \hreftt{http://leksykot.top.hell.pl/lx3/N/atime_mtime_ctime}{mtime}~(\texttt{m}), czas zmiany \hreftt{http://leksykot.top.hell.pl/lx3/N/atime_mtime_ctime}{ctime}~(\texttt{c})\footnote{\texttt{mtime} to~czas ostatniej zmiany zawartości pliku. \texttt{ctime} to~czas ostatniej zmiany informacji o~pliku (np.~zawartości, uprawnień~itd.). \texttt{atime} to~czas ostatniego dostępu do~pliku. $\texttt{mtime} \leq \texttt{ctime} \leq \texttt{atime}$.}. Dwa ostatnie atrybuty --- \texttt{md5} i~\texttt{sha1} --- definiują funkcje skrótu jakie zostaną użyte do~obliczenia skrótów~(\emph{hashy}) śledzonych plików, aby~po~wywołaniu AIDE z~flagą \hreftt{https://linux.die.net/man/1/aide}{--check} lub~\hreftt{https://linux.die.net/man/1/aide}{--compare}, AIDE porównując wybrane atrybuty i~skrót pliku, mógł szybko ocenić które pliki i~katalogi zostały zmodyfikowane. Kompletna lista dostępnych atrybutów przedstawia tabela~\ref{tab:aide-file-attrs}. Reguły rozpoczynające się znakiem ukośnika (\texttt{/}) --- tj.~linie~\ref{line:etc-conf}, \ref{line:bin-conf}, \ref{line:sbin-conf} i~\ref{line:var-conf} --- odpowiadają za~dodanie do~skanowania katalogów \path{/etc}, \path{/bin}, \path{/sbin} i~\path{/var} wraz z~zawartością. Reguły~\ref{line:var-log}, \ref{line:spool} i~\ref{line:var-adm-utmp} zaczynają się~wykrzyknikiem~(\texttt{!}), co~oznacza, że~te~katalogi mają nie być skanowane przez~AIDE. Poza regułami występującymi w~przykładzie~\ref{lst:aide-config}, tj.~regułami rozpoczynającymi się znakiem ukośnika~(\texttt{/}) lub~wykrzyknika~(\texttt{!}), istnieje trzeci rodzaj reguły --- rozpoczynający się znakiem równości~(\texttt{=}) --- oznaczający, że~pliki i~katalogi pasujące do~wyrażenia następującego po~znaku równości zostaną dodane do~tworzonej bazy wynikowej --- tak samo jak ma~to~miejsce w~regule rozpoczynającej się od~ukośnika --- ale w~odróżnieniu od~niej, dzieci podkatalogów katalogów pasujących do~reguły nie zostaną dodane, a~dzieci katalogów pasujących do~danej reguły zostaną dodane tylko wtedy, gdy~reguła kończy się~znakiem ukośnika~(\texttt{/}).

W~ogólności reguły AIDE mogą mieć jedną z~trzech postaci:\mynobreakpar
\begin{itemize}
	\item \texttt{<regex> <file types> <group>}
	\item \texttt{!<regex> <file types>}
	\item \texttt{=<regex> <file types> <group>}
\end{itemize}
gdzie:
\begin{itemize}
	\item \texttt{<regex>} --- wyrażenie regularne rozpoczynające się~ukośnikiem~(\texttt{/}), zgodne wyrażeniami regularnymi występującymi w~języku programowania \href{https://en.wikipedia.org/wiki/Perl}{Perl}~(\hrefemph{https://en.wikipedia.org/wiki/Perl_Compatible_Regular_Expressions}{Perl Compatible Regular Expressions}),
	\item \texttt{<file types>} --- lista będąca filtrem typów plików rozdzielonych przecinkami (może być pusta, wtedy filtrowanie jest wyłączone), do~których zostanie zastosowana dana reguła --- akceptowane typy plików przedstawiono w~tabeli~\ref{tab:aide-file-types},
	\item \texttt{<group>} --- lista atrybutów plików, które definują stan pliku zapisany zgodnie z~następującą, prostą gramatyką:
\begin{lstlisting}[language=,numbers=none,frame=none,xleftmargin=5em,aboveskip=7pt,belowskip=0pt]
<group>| <group> + <predefined group>
       | <group> - <predefined group>
       | <predefined group>
\end{lstlisting}
	gdzie:\mynobreakpar
	\begin{itemize}
		\item \texttt{<predefined group>} to~jeden z~atrybutów z~tabeli~\ref{tab:aide-file-attrs},
		\item sumowanie atrybutów~(\texttt{<group> + <predefined group>}) i~odejmowanie atrybutów (\texttt{<group> - <predefined~group>}) oznacza odpowiednio --- teoriomnogościową sumę i~różnicę atrybutów \texttt{<group>} i~\texttt{<predefined group>}.
	\end{itemize}
\end{itemize}

Konsekwencją zastosowania wyrażeń regularnych w~regułach AIDE jest w~szczególności to, że~zapisanie reguły np.~\path{!/var/adm/utmp} oznacza zignorowanie wszystkich plików, które znajdują się w~katalogu \path{/var/adm} i~których nazwa rozpoczyna się od~napisu \path{utmp} --- np.~plik \path{/var/adm/utmp_root_kit} zostałby zignorowany i~wyłączony z~raportu skanowania~AIDE. Prawidłowa reguła ignorująca tylko plik \path{/var/adm/utmp} to~\path{!/var/adm/utmp$}. Na~początku wyrażenia regularnego dodawany jest \emph{implicite} znak ,,daszka''~(\texttt{\textasciicircum}) oznaczający w~języku wyrażeń regularnych dopasowanie do~początku linii.

\newcommand{\regularfilewiki}{\href{https://en.wikipedia.org/wiki/Unix_file_types\#Regular_file}{zwykłe pliki}}
\newcommand{\directorywiki}{\href{https://en.wikipedia.org/wiki/Unix_file_types\#Directory}{katalogi}}
\newcommand{\symlinkwiki}{\href{https://en.wikipedia.org/wiki/Symbolic_link}{dowiązania symboliczne}}
\newcommand{\chardevwiki}{\href{https://en.wikipedia.org/wiki/Device_file\#Character_devices}{urządzenie znakowe}}
\newcommand{\blockdevwiki}{\href{https://en.wikipedia.org/wiki/Device_file\#Block_devices}{urządzenie blokowe}}
\newcommand{\fifofilewiki}{\href{https://en.wikipedia.org/wiki/Named_pipe}{łącza nazwane}}
\newcommand{\unixsocketwiki}{\href{https://en.wikipedia.org/wiki/Unix_domain_socket}{gniazda UNIX}}
\newcommand{\solariswiki}{\href{https://en.wikipedia.org/wiki/Solaris_(operating_system)}{Solaris}}
\newcommand{\solarisdoorwiki}{\href{https://en.wikipedia.org/wiki/Doors_(computing)}{drzwi}}
\newcommand{\solariseventport}{\href{https://solarisrants.wordpress.com/2013/07/24/solaris-file-event-notification/}{port zdarzenia}}

\begin{table}
	\centering
	\footnotesize
	\begin{tabular}{>{\ttfamily}l|>{\itshape}l|l}
		\textnormal{Typ pliku} & \textnormal{Rozwinięcie skrótu} & Znaczenie atrybutu                     \\\hline\hline
		f                      & regular files                   & \regularfilewiki                       \\\hline
		d                      & directories                     & \directorywiki                         \\\hline
		l                      & symbolic links                  & \symlinkwiki                           \\\hline
		c                      & character devices               & \chardevwiki                           \\\hline
		b                      & block devices                   & \blockdevwiki                          \\\hline
		p                      & FIFO files                      & \fifofilewiki~(pliki FIFO)             \\\hline
		s                      & UNIX sockets                    & \unixsocketwiki                        \\\hline
		D                      & Solaris doors                   & \solarisdoorwiki~systemu \solariswiki  \\\hline
		P                      & Solaris event ports             & \solariseventport~systemu \solariswiki
	\end{tabular}
	\caption[Wszystkie atrybuty plików obsługiwane przez konfigurację AIDE, precyzujące do~jakiego typu pliku mają zastosowanie reguły z~tabeli~\ref{tab:aide-file-attrs}]{Wszystkie atrybuty plików obsługiwane przez konfigurację AIDE, precyzujące do~jakiego typu pliku mają zastosowanie reguły z~tabeli~\ref{tab:aide-file-attrs} (lista z~\emph{\glslink{manual}{manuala}} konfiguracji AIDE --- \hreftt{https://linux.die.net/man/5/aide.conf}{man aide.conf})~\cite{aide-manual}}
	\label{tab:aide-file-types}
\end{table}

Działanie AIDE polega na~tym, że~w~trakcie czytania przez niego swojej \hyperref[lst:aide-config]{konfiguracji}, konstruuje drzewo, którego krawędzie odpowiadają relacji zawierania się skanowanych katalogów i~plików, a~wierzchołki w~przybliżeniu katalogom systemu plików, który będzie przeszukiwany kiedy AIDE zostanie wywołany z~opcją \hreftt{https://linux.die.net/man/1/aide}{--init} lub~\hreftt{https://linux.die.net/man/1/aide}{--scan}~\cite{aide-manual}. W~każdym wierzchołku takiego drzewa znajdują się~trzy listy odpowiadające wszystkim trzem możliwym regułom zaczynającym się od~znaku ukośnika~(\texttt{/}), wykrzyknika~(\texttt{!}) i~znaku równości~(\texttt{=}). Jeśli wierzchołek nie ma~przypisanej którejś reguły, to~lista odpowiadająca danej regule pozostaje pusta. AIDE~umieszcza reguły tak nisko w~drzewie, tzn.~jak najbliżej liści, jak to~tylko możliwe, tak, aby~umieszczane reguły były w~drzewie wyżej niż wszystkie katalogi i~pliki, których dotyczą. Przykładowo reguła \path{!/proc} zostaje umieszczona w~korzeniu drzewa (tzn.~w~wierzchołku~\path{/}), \path{!/proc/.*} w~wierzchołku \path{/proc}, \path{!/var/log/syslog*} w~wierzchołku \path{/var/log}, a~\path{!/home/[a-z0-9]+/.bashrc$} w~wierzchołku \path{/home}. W~momencie gdy~AIDE potrzebuje ustalić czy dany plik o~ścieżce \path{filename} jest włączony do~skanowania, najpierw wyszukuje najgłębiej położony w~drzewie wierzchołek~\path{x}, którego reguły pasują do~pliku \path{filename}, a~następnie wywołuje funkcję rekurencyjną \texttt{check-node\_for\_match(x, filename, true)}\footnote{Funkcję \texttt{check-node\_for\_match(x, filename, true)} można znaleźć w~kodzie źródłowym AIDE w~wersji~\href{https://sourceforge.net/projects/aide/files/aide/0.16/aide-0.16.tar.gz/download}{0.16} --- która jest najnowszą stabilną wersją AIDE w~czasie pisania tej pracy --- w~linii~\href{https://fossies.org/linux/aide/src/gen_list.c\#l_617}{617} w~pliku \href{https://fossies.org/linux/aide/src/gen_list.c}{\path{/src/gen_list.c}}}, której pseudokod przedstawiono w~\href{http://aide.sourceforge.net/stable/manual.html\#config}{instrukcji obsługi}~(\emph{\glslink{manual}{manualu}}) AIDE i~na~listingu~\ref{lst:aide-matching-algorithm}~\cite{aide-manual}. Instrukcja warunkowa \texttt{if} znajdująca się w~\hyperref[line:aide-if-first-time]{drugiej linii listingu} warunkuje wywołanie funkcji \texttt{check} z~linii~\ref{line:aide-check-equals-list}, sprawdzającej czy~plik \texttt{filename} pasuje do~któregokolwiek z~wyrażeń regularnych znajdujących się na~liście odpowiadającej regule rozpoczynającej się od~znaku równości~(\texttt{=}), aby~niepotrzebnie nie sprawdzać spełnienia tej~reguły na~głębszych poziomach rekurencji --- reguła ta~może być tylko spełniona tylko podczas pierwszego wywołania omawianej funkcji, co~wprost wynika z~zasady jej~działania. Linia~\ref{line:aide-check-regular-list} odpowiada za~sprawdzenie czy~plik \texttt{filename} pasuje do~któregoś wyrażenia regularnego z~listy (znajdującej się w~bieżącym wierzchołku drzewa), odpowiadającej regułom rozpoczynającym się od~znaku ukośnika~(\texttt{/}). Linia~\ref{line:aide-recursive-call} to~wywołanie rekurencyjne dla~wierzchołka-rodzica, które zostaje wykonane na~każdym poziomie rekurencji poza ostatnim, kiedy rozpatrywany jest korzeń drzewa (tj.~wierzchołek~\path{/}). W~linii~\ref{line:aide-if-about-to-be-added} następuje sprawdzenie czy~po~wywołaniach rekurencyjnych dla~wierzchołków znajdujących się wyżej w~drzewie, plik \texttt{filename} ma~zostać dodany do~skanowania czy nie --- jeśli tak, to~w~linii~\ref{line:aide-negative-match} zostaje sprawdzona dla~pliku \texttt{filename} reguła rozpoczynająca się od~znaku wykrzyknika~(\texttt{!}). W~linii~\ref{line:aide-return-statement} zostaje zwrócona wartość logiczna \texttt{true} lub~\texttt{false}, która oznacza odpowiednio, że~plik zostanie dodany lub~nie zostanie dodany do~skanowania AIDE.

\begin{lstlisting}[language=,caption={Pseudokod algorytmu wykorzystywanego przez AIDE do~ustalenia czy~plik lub~katalog \protect\path{filename} powinien być dodany do~skanowania AIDE (pseudokod z~instrukcji AIDE)~\cite{aide-manual}},label=lst:aide-matching-algorithm,escapechar=|]
check_node_for_match(node,filename,first_time)
    if (first_time)|\label{line:aide-if-first-time}|
        check(equals list for this node)|\label{line:aide-check-equals-list}|
    check(regular list for this node)|\label{line:aide-check-regular-list}|
    if (node is not the root node)|\label{line:aide-if-node-not-root}|
        check_node_for_match(nodes parent,filename,false)|\label{line:aide-recursive-call}|
    if (this file is about to be added)|\label{line:aide-if-about-to-be-added}|
        check(negative list for this node)|\label{line:aide-negative-match}|
    return (info about whether this file should be added or not and how)|\label{line:aide-return-statement}|
\end{lstlisting}

Oprogramowanie AIDE jest dostępne w~wielu repozytoriach oprogramowania różnych dystrybucji \glslink{unix-like-system}{*niksowych}. Pakiet oprogramowania dostępny w~repozytorium dystrybucji Debian tworzy dodatkowe pliki konfiguracyjne i~skrypt opakowujący \hreftt{https://www.apt-browse.org/browse/debian/jessie/main/all/aide-common/0.16~a2.git20130520-3/file/usr/bin/aide.wrapper}{aide.wrapper}, który uniemożliwia uruchomienie więcej niż~jednej instancji procesu AIDE tworząc plik (\hrefemph{https://unix.stackexchange.com/questions/12815/what-are-pid-and-lock-files-for}{lock file}) \path{/var/run/aide.lock}, a~za~pomocą skryptu \hreftt{https://www.apt-browse.org/browse/debian/jessie/main/all/aide-common/0.16~a2.git20130520-3/file/usr/sbin/update-aide.conf}{update-aide.conf} scala do~pliku \path{/var/lib/aide/aide.conf.autogenerated} konfigurację AIDE rozproszoną po~plikach \emph{rule files}, umieszczonych w~katalogu \path{/etc/aide.conf.d} oraz~uruchamia właściwy program \hreftt{https://linux.die.net/man/1/aide}{aide}. Instalacja AIDE na~Debianie domyślnie uruchamia AIDE codziennie za~pomocą \hreftt{https://en.wikipedia.org/wiki/Cron}{crona}. Konfiguracja dotycząca działań \texttt{crona} w~zakresie regularnego uruchomiania AIDE znajduje się w~plikach \path{/etc/default/aide} i~w~\texttt{/etc/cron.daily/aide}~(który z~kolei wywołuje skrypt \texttt{aide.wrapper}). Domyślnie baza stworzona w~wyniku skanowania systemu programem AIDE jest zapisywana w~pliku \path{/var/lib/aide/aide.db.new}. Logi z~działania AIDE są~domyślnie dostępne w~pliku \path{/var/log/aide/aide.log}. Szczegóły instalacyjne specyficzne dla~Debiana można znaleźć w~pliku \path{/usr/share/doc/aide-common/README.Debian.gz} --- w~szczególności można znaleźć tam wskazówki dotyczące inicjalizacji bazy AIDE za~pomocą skryptu \path{/usr/sbin/aideinit} (\emph{wrapper}) zamiast \hreftt{https://linux.die.net/man/1/aide}{aide~--init}.

W~ramach niniejszej pracy AIDE został wykorzystany do~badania zmian w~konfiguracji systemu wzorcowego. TODO

\newcommand{\inodewiki}{\href{https://en.wikipedia.org/wiki/Inode}{i-węzeł}}
\newcommand{\mdwiki}{\href{https://en.wikipedia.org/wiki/MD5}{MD5}}
\newcommand{\shawiki}{\href{https://en.wikipedia.org/wiki/SHA-1}{SHA-1}}
\newcommand{\shatwowiki}{\href{https://en.wikipedia.org/wiki/SHA-2}{SHA-256}}
\newcommand{\shafivewiki}{\href{https://en.wikipedia.org/wiki/SHA-2}{SHA-512}}
\newcommand{\ripemdwiki}{\href{https://en.wikipedia.org/wiki/RIPEMD}{RIPEMD-160}}
\newcommand{\tigerwiki}{\href{https://en.wikipedia.org/wiki/Tiger_(cryptography)}{Tiger}}
\newcommand{\havalwiki}{\href{https://en.wikipedia.org/wiki/HAVAL}{HAVAL}}
\newcommand{\crcwiki}{\href{https://en.wikipedia.org/wiki/Cyclic_redundancy_check}{CRC-32}}
\newcommand{\gostwiki}{\href{https://en.wikipedia.org/wiki/GOST_(hash_function)}{GOST}}
\newcommand{\whirlpoolwiki}{\href{https://en.wikipedia.org/wiki/Whirlpool_(cryptography)}{Whirlpool}}
\newcommand{\aclwiki}{\href{https://en.wikipedia.org/wiki/Access_control_list}{ACL}}
\newcommand{\selinuxwiki}{\href{https://en.wikipedia.org/wiki/Security-Enhanced_Linux}{SELinux}}
\newcommand{\xattrsman}{\href{http://man7.org/linux/man-pages/man7/xattr.7.html}{rozszerzone atrybuty pliku}}
\newcommand{\xattrswiki}{\href{https://en.wikipedia.org/wiki/Extended_file_attributes\#Linux}{xattrs}}
\newcommand{\extwiki}{\href{https://en.wikipedia.org/wiki/Ext2}{\texttt{ext2}}}
\newcommand{\mtime}{\href{http://leksykot.top.hell.pl/lx3/N/atime_mtime_ctime}{\texttt{mtime}}}
\newcommand{\atime}{\href{http://leksykot.top.hell.pl/lx3/N/atime_mtime_ctime}{\texttt{atime}}}
\newcommand{\ctime}{\href{http://leksykot.top.hell.pl/lx3/N/atime_mtime_ctime}{\texttt{ctime}}}

\begin{table}
	\centering
	\footnotesize
	\begin{tabular}{>{\ttfamily}l|>{\itshape}l|l}
		\textnormal{Atrybut pliku} & \textnormal{Rozwinięcie skrótu}        & Znaczenie atrybutu                      \\\hline\hline
		p                          & permissions                            & uprawnienia do~pliku                    \\\hline
		ftype                      & file type                              & typ pliku                               \\\hline
		i                          & inode                                  & \inodewiki                              \\\hline
		l                          & link name                              & nazwa pliku                             \\\hline
		n                          & number of links                        & liczba dowiązań twardych                \\\hline
		u                          & user                                   & właściciel pliku                        \\\hline
		g                          & group                                  & grupa pliku                             \\\hline
		s                          & size                                   & rozmiar                                 \\\hline
		b                          & block count                            & liczba zajmowanych bloków pamięci       \\\hline
		m                          & mtime                                  & czas modyfikacji                        \\\hline
		a                          & atime                                  & czas dostępu                            \\\hline
		c                          & ctime                                  & czas zmiany                             \\\hline
		S                          & check for growing size                 & sprawdzenie czy~plik się~powiększył     \\\hline
		I                          & ignore changed filename                & ignorowanie zmian nazwy pliku           \\\hline
		ANF                        & allow new files                        & ignorowanie w~raporcie nowych plików    \\\hline
		ARF                        & allow removed files                    & ignorowanie w~raporcie usuniętych plików\\\hline
		md5                        & md5 checksum                           & suma kontrolna \mdwiki                  \\\hline
		sha1                       & sha1 checksum                          & suma kontrolna \shawiki                 \\\hline
		sha256                     & sha256 checksum                        & suma kontrolna \shatwowiki              \\\hline
		sha512                     & sha512 checksum                        & suma kontrolna \shafivewiki             \\\hline
		rmd160                     & rmd160 checksum                        & suma kontrolna \ripemdwiki              \\\hline
		tiger                      & tiger checksum                         & suma kontrolna \tigerwiki               \\\hline
		haval                      & haval checksum                         & suma kontrolna \havalwiki               \\\hline
		crc32                      & crc32 checksum                         & suma kontrolna \crcwiki                 \\\hline
		R                          & \texttt{p+ftype+i+l+n+u+g+s+m+c+md5+X} & skrót                                   \\\hline
		L                          & \texttt{p+ftype+i+l+n+u+g+X}           & skrót                                   \\\hline
		E                          & Empty group                            & pusta grupa                             \\\hline
		X                          & \texttt{acl+selinux+xattrs+e2fsattrs}  & skrót dla rozszerzonych atrybutów pliku \\\hline
		>                          & \texttt{p+ftype+l+u+g+i+n+S+X}         & skrót dla~powiększającego się pliku     \\\hline
		% And also the following if you have mhash support enabled                                                    \\\hline
		gost                       & gost checksum                          & suma kontrolna \gostwiki                \\\hline
		whirlpool                  & whirlpool checksum                     & suma kontrolna \whirlpoolwiki           \\\hline
		%The following are available only when explicitly enabled using configure                                     \\\hline
		acl                        & access control list                    & atrybuty pliku \aclwiki                 \\\hline
		selinux                    & selinux attributes                     & atrybuty pliku \selinuxwiki             \\\hline
		xattrs                     & extended attributes                    & \xattrsman (\xattrswiki)                \\\hline
		e2fsattrs                  & file attributes on a second extended file system & atrybuty pliku na~systemie plików \extwiki
	\end{tabular}
	\caption[Wszystkie atrybuty plików dla~reguł obsługiwanych przez konfigurację~AIDE]{Wszystkie atrybuty plików dla~reguł obsługiwanych przez konfigurację~AIDE\\(lista z~\emph{\glslink{manual}{manuala}} konfiguracji AIDE --- \hreftt{https://linux.die.net/man/5/aide.conf}{man aide.conf})~\cite{aide-manual}}
	\label{tab:aide-file-attrs}
\end{table}

%------------------------------------------------------------------------------
%
%\subsection{Generowanie pakietu oprogramowania}
%
%W~celu łatwej instacji powstałego oprogramowania, została przygotowana paczka instalacyjna... TODO

%------------------------------------------------------------------------------
%
%\subsection{Wireshark}
%
%Wireshark jest narzędziem do~analizowania pakietów i~dlatego był jednym z~najczęściej z~używanych narzędzi w~czasie implementacji projektu. Bez Wiresharka podgląd przesyłanych pakietów byłby trudny, szczególnie, że~przesyłane pakiety są~szyfrowane z~wykorzystaniem biblioteki OpenSSL~(patrz rozdział~\ref{sec:security}). Wireshark umożliwia łatwe dekodowanie pakietów po~podaniu klucza prywatnego użytego do~szyfrowania, co~czyni z~niego bardzo wygodne narzędzie do~analizy zaszyfrowanego ruchu sieciowego.

\end{document}
