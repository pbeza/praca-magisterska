\documentclass[thesis]{subfiles}

\begin{document}

\chapter{Implementacja}

W~niniejszym rozdziale przedstawiono szczegóły implementacyjne projektu, w~szczególności opisano sposób użycia aplikacji klienckiej i~aplikacji serwera, będącego systemem wzorcowym, zastosowane biblioteki i~narzędzia pomocnicze.

%------------------------------------------------------------------------------

\section{Moduły aplikacji}

Aplikacja składa się z~części serwerowej i~klienckiej, nazywanej w~kodzie źródłowym odpowiednio \texttt{myscm-srv} i~\texttt{myscm-cli}\footnote{\emph{myscm} to~skrót od~roboczej nazwy stworzonego oprogramowania --- \emph{My~\href{https://en.wikipedia.org/wiki/Software_configuration_management}{Software Configuration Manager}}}. Każda z~tych części składa się z~modułów realizujących rozłączone zadania.

Wyróżnione moduły serwera:\mynobreakpar
\begin{itemize}
	\item moduł skanujący system wzorcowy i~tworzący plik opisujący zmiany jakie zaszły w~konfiguracji systemu od~czasu pierszego skanowania systemu wzorcowego --- moduł ten~wykorzystuje do~swojego działania skaner~\hyperref[sec:aide]{AIDE} (patrz rozdział~\ref{sec:aide}),
	\item moduł tworzący na~podstawie pierwszego i~ostatniego skanowania systemu wzorcowego, podpisany cyfrowo obraz zmian konfiguracji, będący archiwum plików dla~klienta, które zostaje rozpakowane i~zastosowane przez aplikację kliencką\footnote{W~przypadku konfliktów zmian, administrator może na~etapie użycia aplikacji klienckiej, interaktywnie porównać oba~pliki i~zdecydować która wersja konfliktowego pliku ma~być zachowana lub~alternatywnie może wymusić nadpisanie plików.},
	\item moduł udostępniający klientom tak~stworzony obraz zmian konfiguracji systemu wzorcowego,
	\item moduł konfiguracji aplikacji serwera --- konfiguracja ta~zawiera m.in.~ustawienia numeru portu nasłuchu na~połączenia klientów, ścieżkę do~pliku konfiguracyjnego~AIDE, określającego jakie katalogi powinny być~skanowane, ścieżkę do~klucza prywatnego certyfikatu cyfrowego serwera, używanego do~podpisywania obrazów zmian konfiguracji, ścieżkę do~katalogu, w~którym są~zapisywane generowane obrazy konfiguracji~itp.
\end{itemize}

Wyróżnione moduły klienta:\mynobreakpar
\begin{itemize}
	\item moduł odbierający, weryfikujący podpis cyfrowy, rozpakowujący i~stosujący obraz zmian konfiguracji wzorcowej udostępniony przez serwer,
	\item moduł konfiguracji aplikacji klienta --- konfiguracja ta~zawiera m.in.~ustawienia numeru portu nasłuchiwania serwera, protokół wykorzystany do~połączenia z~serwerem, ścieżkę do~katalogu, w~którym są~zapisywane odebrane od~serwera obrazy konfiguracji~itp.
\end{itemize}

%------------------------------------------------------------------------------

\section{Aplikacja serwera}

\newcommand{\srvappname}{myscm-srv}
\newcommand{\myscmsrvconfig}{\path{/etc/myscm-srv/myscm-srv.conf}}

Aplikacja serwera to~aplikacja przeznaczona do~użycia z~uprawnieniami \hreftt{https://en.wikipedia.org/wiki/Superuser}{root}\footnote{Uprawnienia administratora są~konieczne do~uruchomienia skanowania~\hyperref[sec:aide]{AIDE}.} na~maszynie będącej wzorcem oprogramowania dla~klientów. Służy ona do~dwóch celów --- do~stworzenia obrazu zmian konfiguracji przeprowadzonych przez administratora komputerowego od~czasu pierwszego skanowania~(por.~rozdział~\ref{sec:tworzenie-obrazu-konfiguracji}) i~do~udostępnienia takiego obrazu klientowi~(por.~rozdział~\ref{sec:przeslanie-obrazu-konfiguracji}). Główną funkcjonalnością aplikacji serwera jest stworzenie obrazu zmian konfiguracji, ponieważ utworzony obraz może być udostępniony klientowi w~dowolny inny sposób --- np.~za~pomocą protokołów \href{https://en.wikipedia.org/wiki/Trivial_File_Transfer_Protocol}{TFTP}~(\emph{Trivial File Transfer Protocol}), \href{https://en.wikipedia.org/wiki/SSH_File_Transfer_Protocol}{SFTP}~(\emph{SSH File Transfer Protocol}), \href{https://en.wikipedia.org/wiki/File_Transfer_Protocol}{FTP} --- wszystkie te~protokoły wspiera aplikacja kliencka, a~ponadto ma~możliwość załadowania obrazu zmian konfiguracji z~wybranego pliku obrazu konfiguracji.

Szczegółowa instrukcja obsługi użycia aplikacji serwera została dostarczona z~przygotowanym pakietem oprogramowania \texttt{\srvappname}~(patrz~załącznik~\ref{ch:cd-appendix}). Instrukcję można otworzyć po~zainstalowaniu pakietu \texttt{\srvappname} za~pomocą komendy \texttt{man~\srvappname}. Konfiguracja aplikacji znajduje się w~katalogu \myscmsrvconfig.

\begin{lstlisting}[label=lst:myscm-srv-usage,numbers=none,caption={Szablon użycia aplikacji serwera o~nazwie \texttt{myscm-srv}}]
myscm-srv [OPCJE]
\end{lstlisting}

Listing~\ref{lst:myscm-srv-usage} przedstawia skrócony szablon użycia aplikacji serwera, gdzie argumenty opcji ujęte w~nawiasy kwadratowe \texttt{[~]} oznaczają opcjonalność tych argumentów\footnote{Argumenty opcjonalne, które mają swoje odpowiedniki w~pliku konfiguracyjnym, powodują zignorowanie odpowiedników z~pliku konfiguracyjnego --- dotyczy to~zarówno aplikacji serwera, jak i~aplikacji klienckiej.}, a~\texttt{OPCJE} oznaczają następujące dozwolone opcje:\mynobreakpar

\setlist[description]{style=nextline,font=\ttfamily}
\begin{description}
	\item[-i, --init {[AIDE\_CONFIG\_FILE]}]\hypertarget{itm:srv-init} Inicjuje bazę \hyperref[sec:aide]{AIDE} korzystając z~pliku konfiguracyjnego~AIDE wskazywanego przez plik konfiguracyjny aplikacji serwera lub~przez opcjonalny parametr \path{AIDE_CONFIG_FILE}. Wynik skanowania zostaje zapisany w~pliku ustawionym w~konfiguracji aplikacji --- domyślnie jest to~plik tekstowy \path{/var/lib/myscm-srv/aide.db}. Tak~stworzona baza jest referencyjną konfiguracją systemu wzorcowego, która będzie porównywana z~kolejnymi wynikami skanowań (patrz opcja \hyperlink{itm:srv-update}{\texttt{--update}}).
	\item[--update {[SCAN\_OUT\_FILE]}]\hypertarget{itm:srv-update} Skanuje system w~poszukiwaniu zmian od~czasu pierwszego skanowania \hyperref[sec:aide]{AIDE}, wykonanego za~pomocą wywołania programu z~opcją \hyperlink{itm:srv-init}{\texttt{--init}}. Wynikiem skanowania jest plik tekstowy \path{/var/lib/myscm-srv/aide.db.new}\footnote{Jeśli już taki plik istnieje, to~starsza wersja \path{aide.db.new} zostaje przeniesiona do~\path{aide.db.old}, nadpisując plik o~tej samej nazwie jeśli taki istnieje. Dzięki zachowaniu \path{aide.db.old} możliwe jest przywrócenie poprzedniej konfiguracji.}, na~podstawie którego może powstać obraz zmian konfiguracji systemu wzorcowego od~czasu pierwszego skanowania systemu~(patrz opcja \hyperlink{itm:srv-gen-img}{\texttt{--gen-img}}). Jeśli opcjonalny parametr \path{SCAN_OUT_FILE} jest podany, to~wynik skanowania zostaje zapisany w~pliku \path{SCAN_OUT_FILE}, nadpisując ewentualny istniejący plik o~tej samej nazwie.
	\item[-g, --gen-img {[MYSCM\_IMG\_FILE]}]\hypertarget{itm:srv-gen-img} Tworzy obraz zmian na~podstawie pierwszego i~ostatniego skanowania~AIDE wykonanego odpowiednio za~pomocą opcji \hyperlink{itm:srv-init}{\texttt{--init}} i~\hyperlink{itm:srv-update}{\texttt{--update}} --- ścieżki do~plików będącymi wynikami działania programu uruchomionego z~tymi opcjami są~ustawiane w~konfiguracji aplikacji. Obraz zmian konfiguracji to~archiwum\footnote{Rodzaj użytej kompresji jest konfigurowalny. Domyślnie plik obrazu konfiguracji jest skompresowany za~pomocą \hreftt{https://en.wikipedia.org/wiki/Tar_(computing)}{tar} i~\hreftt{https://en.wikipedia.org/wiki/Gzip}{gzip} do~pliku archiwum z~rozszerzeniem \texttt{tar.gz}.}, które domyślnie zostaje zapisane w~pliku \path{/var/lib/myscm-srv/myscm-img.tar.gz} lub~w~\path{MYSCM_IMG_FILE}, jeśli ten~argument zostanie podany. Jeśli obraz konfiguracji o~tej samej nazwie już istnieje, to~zostaje nadpisany.
	\item[--upgrade] Wywołuje program tak, jakby był wywołany najpierw z~opcją \hyperlink{itm:srv-update}{\texttt{--update}}, a~następnie z~opcją \hyperlink{itm:srv-gen-img}{\texttt{--gen-img}} --- oba~wywołania bez~dodatkowych argumentów.
	\item[-c, --config CONFIG\_FILE] Domyślnie konfiguracja aplikacji serwera jest czytana z~pliku tekstowego \myscmsrvconfig. Ta~opcja zmienia to~zachowanie wczytując konfigurację aplikacji serwera z~pliku tekstowego \texttt{CONFIG\_FILE}.
	\item[-s, --share {[MYSCM\_IMG\_FILE]}]\hypertarget{itm:srv-share} Włącza udostępnianie obrazu utworzonego za~pomocą opcji \hyperlink{itm:srv-gen-img}{\texttt{--gen-img}} na~porcie określonym przez konfigurację serwera lub~na~porcie \texttt{PORT\_NUMBER} określonym przez opcję \hyperlink{itm:srv-port}{\texttt{--port}}. Jeśli \texttt{MYSCM\_IMG\_FILE} jest podany, to~zamiast domyślnego obrazu, jest udostępniany obraz określony ścieżką \texttt{MYSCM\_IMG\_FILE}.
	\item[-p, --port PORT\_NUMBER]\hypertarget{itm:port} Ustawia port nasłuchu na~klientów na~\texttt{PORT\_NUMBER}. Ta~opcja ma~sens tylko w~połączeniu z~opcją \hyperlink{itm:srv-share}{\texttt{--share}} i~zostaje ona zignorowana w~przypadku braku tej~opcji.
	%\item[--force]
	\item[-d, --daemonize {[TIME\_INTERVAL]}] Uruchamia aplikację w~tle i~włącza cykliczne skanowanie systemu co~pewien czas ustawiony w~konfiguracji serwera lub~co~czas wyrażony w~minutach za~pomocą opcjonalnego parametru \texttt{TIME\_INTERVAL}. Jeśli obecna jest również opcja \hyperlink{itm:srv-share}{\texttt{--share}}, to~poza cyklicznym skanowaniem, w~tle działa udostępnianie najnowszego obrazu konfiguracji. Wszystkie komunikaty programu zostają przekierowane do~\hreftt{https://en.wikipedia.org/wiki/Syslog}{sysloga} lub~do~pliku z~logami, zdefiniowanym w~konfiguracji aplikacji serwera.
	\item[--version] Wypisuje informację o~wersji i~licencji aplikacji serwera.
	\item[-h, --help] Wypiuje pomoc w~języku angielskim z~informacjami o~dozwolonych opcjach aplikacji serwera i~ich znaczeniu.
	\item[-v, --verbose] Włącza tryb ,,gadatliwy", tzn.~włącza wypisywanie dodatkowych komunikatów mogących okazać się pomocnymi przy diagnozowaniu ewentualnych problemów z~działaniem programu.
\end{description}

%------------------------------------------------------------------------------

\section{Aplikacja kliencka}

\newcommand{\cliappname}{myscm-cli}
\newcommand{\myscmcliconfig}{\path{/etc/myscm-cli/myscm-cli.conf}}

Aplikacja kliencka to~aplikacja przeznaczona do~użycia z~uprawnieniami \hreftt{https://en.wikipedia.org/wiki/Superuser}{root}\footnote{Uprawnienia administratora są~konieczne do~tworzenia, zmiany i~usuwania plików z~dowolnej częsci systemu plików, co~jest konieczne podczas zastosowania obrazu zmian konfiguracji systemu wzorcowego.} na~maszynie, której konfigurację administrator chce dostosować do~konfiguracji systemu wzorcowego. Aplikacja kliencka umożliwia pobranie obrazu zmian konfiguracji z~serwera za~pomocą \href{https://en.wikipedia.org/wiki/Trivial_File_Transfer_Protocol}{TFTP}~(\emph{Trivial File Transfer Protocol}), \href{https://en.wikipedia.org/wiki/SSH_File_Transfer_Protocol}{SFTP}~(\emph{SSH File Transfer Protocol}), \href{https://en.wikipedia.org/wiki/File_Transfer_Protocol}{FTP} lub~własnego protokołu, a~następnie umożliwia zastosowanie~go na~systemie klienckim.

Szczegółowa instrukcja obsługi użycia aplikacji klienckiej, analogicznie jak w~przypadku aplikacji serwera, została dostarczona z~przygotowanym pakietem oprogramowania \texttt{\cliappname}~(patrz~załącznik~\ref{ch:cd-appendix}). Instrukcję można otworzyć po~zainstalowaniu pakietu \texttt{\cliappname} za~pomocą komendy \texttt{man~\cliappname}. Konfiguracja aplikacji znajduje się w~katalogu \myscmcliconfig.

\begin{lstlisting}[numbers=none,language=,caption={Szablon użycia aplikacji klienckiej dostosowującej konfigurację systemu klienta do~konfiguracji pobranej z~serwera o~IP \texttt{server\_IP} lub~z~pliku obrazu konfiguracji określonego ścieżką \texttt{myscm\_img\_file}},label=lst:myscm-cli-usage]
myscm-cli [OPCJE] [server_IP | myscm_img_file]
\end{lstlisting}

Listing~\ref{lst:myscm-cli-usage} przedstawia skrócony szablon użycia aplikacji klienckiej, gdzie argumenty opcji ujęte w~nawiasy kwadratowe \texttt{[~]} oznaczają opcjonalność tych argumentów, a~\texttt{OPCJE} oznaczają następujące dozwolone opcje:\mynobreakpar

\begin{description}
	\item[--upgrade]\hypertarget{itm:cli-upgrade} Pobiera obraz zmian konfiguracji z~serwera zdefiniowanego w~konfiguracji systemu aplikacji klienckiej do~pliku określonego przez tę~konfigurację (domyślnie do~pliku \path{/var/myscm-cli/myscm-img.tar.gz}), sprawdza poprawność certyfikatu cyfrowego, którym jest podpisany i~jeśli jest on~poprawny, stosuje~go na~systemie klienta. Jeśli w~konfiruacji obecnej i~stosowanej są~konflikty, administrator może interaktywnie je~rozwiązać. W~przypadku obecności w~wywołaniu programu opcjonalnego adresu IP~serwera \texttt{server\_IP} lub~ścieżki do~pliku obrazu \texttt{myscm\_img\_file}, obraz zmian konfiguracji zostaje pobrany odpowiednio z~serwera o~zadanym adresie~IP, za~pomocą protokołu zdefiniowanego w~konfiguracji aplikacji klienckiej bądź z~pliku o~zadanej ścieżce.
	\item[--update {[MYSCM\_IMG\_FILE]}] Działa jak \texttt{--upgrade}, tylko nie stosuje obrazu na~systemie klienckim, tzn.~pobiera obraz zmian konfiguracji systemu z~serwera zdefiniowanego w~konfiguracji aplikacji klienckiej do~pliku określonego przez tę~konfigurację (domyślnie to~plik \path{/var/myscm-cli/myscm-img.tar.gz}) lub~do~pliku \path{MYSCM_IMG_FILE} jeśli jest podany, sprawdza poprawność certyfikatu cyfrowego, którym jest podpisany i~nie stosuje jej~na~systemie klienta. W~przypadku obecności w~wywołaniu programu opcjonalnego adresu IP~serwera \texttt{server\_IP}, obraz zmian konfiguracji zostaje pobrany z~zadanego adresu~IP za~pomocą protokołu zdefiniowanego w~konfiguracji aplikacji klienckiej. W~przypadku gdy w~wywołaniu programu podana jest ścieżka do~pliku obrazu \texttt{myscm\_img\_file}, zostaje ona~zignorowana i~program kończy działanie nie pobierając żadnego obrazu zmian konfiguracji.
	\item[--SFTP, --FTP]\hypertarget{itm:cli-sftp} Wymusza zastosowanie protokołu (S)FTP do~połączenia z~serwerem. Dane połączenia takie jak np.~nazwa użytkownika, hasło i~port są~pobierane z~konfiguracji aplikacji.
	\item[--cert X509\_cert\_file] Sprawdza poprawność obrazu konfiguracji za~pomocą certyfikatu cyfrowego zapisanego w~pliku określonego ścieżką \path{X509_cert_file}. Jeśli ta~opcja nie jest podana, to~domyślnie używany certyfikat cyfrowy jest ustawiony w~konfiguracji aplikacji.
	\item[--force] Wymusza nadpisanie plików na~systemie klienta w~przypadku zaistnienia konfliktów podczas zastosowania obrazu systemu. Ta~opcja ma~sens tylko w~połączeniu z~opcją \texttt{--upgrade}.
	\item[-p, --port PORT\_NUMBER] Wymusza połączenie do~serwera na~porcie \texttt{PORT\_NUMBER} za~pomocą protokołu określonego w~konfiguracji aplikacji klienckiej lub~za~pomocą protokołu określonego flagą \hyperlink{itm:cli-sftp}{\texttt{--SFTP}} lub~\hyperlink{itm:cli-sftp}{\texttt{--FTP}}.
	\item[-d, --daemonize {[TIME\_INTERVAL]}] Uruchamia aplikację w~tle i~włącza cykliczny \hyperlink{itm:cli-upgrade}{\texttt{--upgrade}} systemu. Czas odstępu między kolejnymi aktualizacjami jest ustawiony w~konfiguracji aplikacji klienckiej lub~w~opcjonalnym parametrze \texttt{TIME\_INTERVAL} wyrażonym w~minutach. Wszystkie komunikaty programu zostają przekierowane do~\hreftt{https://en.wikipedia.org/wiki/Syslog}{sysloga} lub~do~pliku z~logami, zdefiniowanym w~konfiguracji aplikacji serwera.
	\item[--version] Wypisuje informację o~wersji i~licencji aplikacji klienckiej.
	\item[-h, --help] Wypiuje pomoc w~języku angielskim z~informacjami o~dozwolonych opcjach aplikacji klienckiej i~ich znaczeniu.
	\item[-v, --verbose] Włącza tryb ,,gadatliwy", tzn.~włącza wypisywanie dodatkowych komunikatów mogących okazać się pomocnymi przy diagnozowaniu ewentualnych problemów z~działaniem programu.
\end{description}

%------------------------------------------------------------------------------

\section{Kod źródłowy}

Kod źródłowy projektu został w~całości napisany w~języku \href{https://en.wikipedia.org/wiki/Python_(programming_language)}{Python} w~najnowszej dostępnej w~trakcie pisania tej pracy wersji~3.6.1. Źródła projektu znajdują się na~płycie~CD dołączonej do~tej pracy (patrz załącznik~\ref{ch:cd-appendix}) w~katalogu~\path{/src}, a~dokumentacja wygenerowana z~komentarzy kodu źródłowego w~\path{/doc/python}.

Kod źródłowy został sformatowany zgodnie z~wymogami \href{https://www.python.org/dev/peps/pep-0008/}{PEP~8} (\emph{Python Enhancement Proposals}) pt.~\emph{Style Guide for Python Code} i~\href{https://www.python.org/dev/peps/pep-0257/}{PEP~257} pt.~\emph{Docstring Conventions}. Do~sprawdzenia zgodności napisanego kodu ze~standardem~PEP~8 wykorzystano narzędzie \hreftt{https://pypi.python.org/pypi/flake8}{flake8}, który obudowuje (\emph{wrapper}) narzędzia \hreftt{https://pypi.python.org/pypi/pep8}{pep8}, \hreftt{https://pypi.python.org/pypi/pyflakes}{pyflakes}, \hreftt{https://pypi.python.org/pypi/pycodestyle}{pycodestyle} i~\hreftt{https://pypi.python.org/pypi/mccabe}{mccabe}. Edytorem kodu wykorzystanym do~implementacji był \texttt{vim} rozbudowany o~\href{http://vimawesome.com/}{wtyczki}~(\emph{plugins}).

%------------------------------------------------------------------------------

\section{Wykorzystane biblioteki}

Do~implementacji projektu wykorzystano wiele \href{https://docs.python.org/dev/tutorial/modules.html}{modułów} Pythona, kilka pomocniczych aplikacji i~bibliotek. Wyróżnione z~nich~to:
\begin{itemize}
	\item \href{http://aide.sourceforge.net/}{AIDE} (\emph{Advanced Intrusion Detection Environment}) --- skaner integralności plików zaprojektowany w~celu wykrywania złośliwego oprogramowania, np.~\hrefemph{https://en.wikipedia.org/wiki/Rootkit}{rootkitów}. W~niniejszym projekcie został wykorzystany do~wykrywania zmian w~konfiguracji systemu wzorcowego (patrz rozdział~\ref{sec:aide}).
	\item \href{http://www.pyopenssl.org/}{pyOpenSSL} --- \hrefemph{https://en.wikipedia.org/wiki/Language_binding}{Binding} dla~biblioteki OpenSSL. Biblioteka ta~implementuje wiele protokołów i~algorytmów kryptograficznych, ale~w~ramach projektu została wykorzystana tylko w~celu umożliwia uwierzytelnienie serwera przez klienta przez użycie certyfikatów cyfrowych.
%	\item \hreftt{http://zeromq.org/}{ØMQ} --- Znana jest również pod~nazwą \emph{ZeroMQ} --- biblioteka implementująca różne wzorce przekazywania komunikatów~(\emph{messaging library}), dedykowana przede wszystkim dla~wydajnych, rozproszonych środowisk sieciowych. Wzorcem wykorzystanym w~implementacji niniejszego projektu jest wzorzec \hrefemph{https://rfc.zeromq.org/spec:29/PUBSUB/}{Publish-Subscribe}, implementowany na~różne sposoby --- jednym ze~sposobów jest wykorzystanie protokołu~\hyperref[subsec:pgm]{PGM}, pośrednio implementowanego przez~\href{https://en.wikipedia.org/wiki/ZeroMQ}{ØMQ} przez wykorzystanie implementacji \href{https://github.com/steve-o/openpgm}{OpenPGM}. Biblioteka została napisana w~języku~C++, ale~powstały również \emph{bindingi} dla~ponad 40~innych języków programowania --- m.in.~dla~Pythona, w~którym został zaimplementowany niniejszy projekt. ØMQ~została opublikowana na~warunkach licencji~\glslink{lgpl}{LGPL}.
%	\item \hreftt{https://en.wikipedia.org/wiki/Squid_(software)}{Squid} lub\footnote{TODO --- wybór tego, który lepiej się sprawdzi --- oba da się skonfigurować do~pracy na~\emph{Debianie} i~\emph{Archu}.} \hreftt{https://www.unix-ag.uni-kl.de/~bloch/acng/html/}{Apt-Cacher-NG} jako serwer buforujący pakiety oprogramowania dla~klienta (\href{https://lwn.net/Articles/318658/}{Package Repository Proxy}).
%Istnieje wiele bibliotek kryptograficznych, które, pod~warunkiem poprawnego użycia, mogą istotnie poprawić bezpieczeństwo protokołu. Najpopularniejsze z~nich~to: \emph{\gls{openssl}}, \emph{GnuTLS}, \emph{LibreSSL} i~\emph{BoringSSL}. Biblioteką istniejącą najdłużej z~wymienionych jest \gls{openssl}. Biblioteka GnuTLS powstała w~odpowiedzi na~\gls{openssl} ze~względu na~to, że~\gls{openssl} nie jest opublikowana na~licencji kompatybilnej z~licencją~\glslink{gpl}{GPL}, przez co~liczne projekty korzystające licencji~\glslink{gpl}{GPL} (np.~\emph{Wireshark}), nie mogą korzystać z~\gls{openssl}. Biblioteki LibreSSL i~BoringSSL są~\emph{fork'ami} biblioteki \gls{openssl}. BoringSSL powstał w~\emph{Google} na~potrzeby użycia w~różnych produktach tej firmy, w~szczególności w~przeglądarce internetowej Chrome. Długa historia \gls{openssl}, mnogość bibliotek pokrewnych, mających źródło w~kodzie źródłowym \gls{openssl} oraz~względnie duża społeczność kryptologów zgromadzonych wokół tego projektu, spowodowały, że~biblioteka \gls{openssl} została użyta do~zapewnienia bezpieczeństwa opracowanego protokołu sieciowego.
%\gls{openssl} udostępnia wiele metod i~algorytmów kryptograficznych, które przetrwały wiele lat kryptoanaliz (np.~\gls{aes}, \gls{rsa}) i~są powszechnie uważane za~bezpieczne, pod~warunkiem poprawnego ich~wykorzystania i~zastosowania kluczy o~odpowiednio dużej długości. Wykorzystanie tej biblioteki w~kontekście komunikacji między klientem i~serwerem zostało opisane w~rozdziale~\ref{sec:security}, dotyczącym bezpieczeństwa opracowanego protokołu.
%	\item \hreftt{http://pyyaml.org/}{PyYAML} --- Służy do~parsowania plików konfiguracyjnych \texttt{YAML} serwera i~klienta.
\end{itemize}

%------------------------------------------------------------------------------

\section{AIDE}
\label{sec:aide}

Kluczowym narzędziem wykorzystanym w~implementacji projektu jest~\href{http://aide.sourceforge.net/}{AIDE}~(\emph{Advanced Intrusion Detection Environment}). \href{https://wiki.archlinux.org/index.php/AIDE}{AIDE}~jest oprogramowaniem zaprojektowanym z~myślą wykrywania zmian w~systemie plików w~celu wykrycia złoźliwego oprogramowania\footnote{Taki rodzaj oprogramowania jest nazywany oprogramowaniem~\href{https://en.wikipedia.org/wiki/Host-based_intrusion_detection_system_comparison}{HIDS}~(\hrefemph{https://wiki.archlinux.org/index.php/List_of_applications/Security\#Threat_and_vulnerability_detection}{Host-based Intrusion Detection System}).}, jednak sposób jego działania nie ogranicza wykorzystania go~tylko do~tego celu. AIDE~został zapoczątkowany przez \href{http://www.ipi.fi/~rammer/cv.html}{Ramiego Lehtiego}\footnote{\href{http://www.ipi.fi/~rammer/cv.html}{Będącego} w~latach 1996--1999 administratorem komputerowym w~\href{http://www.tut.fi/en}{Tampere University of~Technology~(TUT)} w~Finlandii.} oraz~\href{https://www.linkedin.com/in/pablo-virolainen-73501731/}{Pablo Virolainena} w~1999~roku. AIDE~jest w~całości napisany w~języku~\href{https://en.wikipedia.org/wiki/C_(programming_language)}{C} i~jest objęty \glslink{gpl}{licencją~GPL}.

Działanie AIDE polega na~wykonywaniu migawek systemu~(\emph{snapshot}) zawierającego m.in.~skróty plików~(\emph{files' \href{https://en.wikipedia.org/wiki/Hash_function}{hashes}}), czas ich~modyfikacji, uprawnienia i~inne parametry plików zdefiniowane przez administratora w~konfiguracji \path{/etc/aide/aide.conf}. Konfiguracja ta~jest zapisana w~formacie podobnym do~tego, który został użyty w~komercyjnym oprogramowaniu \hrefemph{https://en.wikipedia.org/wiki/Open_Source_Tripwire}{Tripwire}, będącym pierwowzorem dla~AIDE. Pierwsza migawka systemu wykonana komendą \texttt{aide --init} typowo powinna zostać wykonana na~dopiero~co zainstalowanym systemie operacyjnym przed podłączeniem go~do~sieci i~zostać zapisana na~systemie plików tylko do~odczytu~(\emph{read-only}) lub~na~nośniku niepodłączonym do~działającego systemu (\hrefemph{https://www.techopedia.com/definition/30275/cold-storage}{cold storage}), ponieważ jest ona~referencyjnym stanem systemu, będącym punktem odniesienia dla~kolejnych migawek\footnote{Instrukcja użytkownika AIDE \href{http://aide.sourceforge.net/stable/manual.html\#usage}{zaleca} przeniesienie na~bezpieczne nośniki również binaria, konfigurację i~instukcję ~AIDE.}. Zapisanie pierwszej migawki na~partycji \href{https://linux.die.net/man/8/mount}{zamontowanej} w~trybie tylko do~odczytu i/lub~umieszczenie jej~na~bezpiecznym nośniku minimalizuje ryzyko jej modyfikacji z~jakiegokolwiek powodu --- np.~z~powodu złośliwego oprogramowania, awarii, przypadkowego nadpisania~itd. Migawki wykonane podczas kolejnych skanowań, wykonane komendą \texttt{aide~-C}, są~porównywane z~pierwszą migawką i~na~tej podstawie AIDE~tworzy tekstowy raport zmian.

\begin{lstlisting}[language=,caption={Zawartość pliku \protect\path{/etc/aide/aide.conf} z~przykładową konfiguracją~AIDE (ze~strony~\hreftt{http://aide.sourceforge.net/stable/manual.html}{aide.sourceforge.net/stable/manual.html})},label=lst:aide-config,escapechar=|]
MyRule = p+i+n+u+g+s+b+m+c+md5+sha1|\label{line:custom-rule}|
/etc p+i+u+g     # check only permissions, inode, user and group for etc
/bin MyRule      # apply the custom rule to the files in bin
/sbin MyRule     # apply the same custom rule to the files in sbin
/var MyRule
!/var/log/.*     # ignore the log dir it changes too often|\label{line:var-log}|
!/var/spool/.*   # ignore spool dirs as they change too often|\label{line:spool}|
!/var/adm/utmp$  # ignore the file /var/adm/utmp|\label{line:var-adm-utmp}|
\end{lstlisting}

W~drzewie katalogów systemów \glslink{unix-like-system}{*niksowych}\footnote{Struktura drzewa katalogów systemów \glslink{unix-like-system}{*niksowych} jest zdefiniowana przez \hrefemph{https://wiki.linuxfoundation.org/lsb/fhs}{Filesystem Hierarchy Standard}~(\href{http://www.tldp.org/LDP/sag/html/fs-background.html}{FHS}).} istnieją katalogi systemowe, tzn.~katalogi niebędące katalogiem domowym użytkownika ani jego podkatalogiem, których zawartość zmienia się np.~co~każde uruchomienie systemu i~takie zachowanie nie powinno zazwyczaj niepokoić administratora, dlatego powinny być one (i~część z~nich jest domyślnie) wyłączone ze~skanowania~AIDE. Do~takich katalogów należą~m.in.~katalogi:

\begin{itemize}
	\item \hreftt{http://www.tldp.org/LDP/sag/html/var-fs.html}{/var} --- katalog, w~którym znajdują się \href{http://www.linuxpl.org/SAG/x547.html}{m.in.}~logi w~\path{/var/log}, blokady plików w~\path{/var/lock}, \emph{cache} w~\path{/var/cache}, \href{http://www.tldp.org/HOWTO/Printing-Usage-HOWTO-2.html}{kolejki wydruku} i~kolejki pocztowe w~\path{/var/spool}~itp.,
	\item \hreftt{http://www.tldp.org/LDP/Linux-Filesystem-Hierarchy/html/tmp.html}{/tmp} --- katalog z~danymi tymczasowymi.
\end{itemize}

 Do~katalogów, które również powinny być wyłączone ze~skanowania AIDE należą katalogi specjalne, np.~katalogi wirtualne, których istnienie zapewnia w~locie (\emph{on the fly}) \glslink{kernel}{jądro} systemu operacyjnego:

\begin{itemize}
	\item \hreftt{https://www.kernel.org/doc/Documentation/filesystems/sysfs.txt}{/sys} --- katalog zawierający m.in.~informacje o~urządzeniach podłączonych do~komputera,
	\item \hreftt{http://www.tldp.org/LDP/sag/html/proc-fs.html}{/proc} --- katalog \hreftt{https://en.wikipedia.org/wiki/Procfs}{procfs}, zawierający informacje o~działających procesach,
	\item \hreftt{http://www.tldp.org/LDP/sag/html/dev-fs.html}{/dev} --- katalog zawierający \href{https://en.wikipedia.org/wiki/Device_file}{pliki urządzeń},
	\item \hreftt{https://unix.stackexchange.com/questions/13972/what-is-this-new-run-filesystem/13973}{/run} --- katalog zawierający dane dotyczące np.~aktualnie zalogowanych użytkowników i~działających \glslink{demon}{demonów}; często montowany w~systemie plików \hreftt{https://wiki.archlinux.org/index.php/Tmpfs}{tmpfs}.
	\item \hreftt{http://www.tldp.org/LDP/Linux-Filesystem-Hierarchy/html/media.html}{/media} --- miejsce montowania np.~tymczasowo podłączonych nośników danych (\emph{removable media}),
	\item \hreftt{http://www.tldp.org/LDP/Linux-Filesystem-Hierarchy/html/mnt.html}{/mnt} --- miejsce tymczasowego montowania systemów plików.
\end{itemize}

W~ramach niniejszej pracy AIDE został wykorzystany do~badania zmian w~konfiguracji systemu wzorcowego. Listing~\ref{lst:aide-config} przedstawia przykładową konfigurację~AIDE. W~\hyperref[line:custom-rule]{pierwszej linii} została zdefiniowana reguła, która określa jakie parametry pliku definiują jego stan. W~tym przykładzie są~to \href{https://www.linux.com/learn/understanding-linux-file-permissions}{uprawnienia do~pliku}~(\texttt{p}), \href{https://en.wikipedia.org/wiki/Inode}{i-węzeł}~(\texttt{i}), liczba \href{https://en.wikipedia.org/wiki/Hard_link}{dowiązań twardych}~(\texttt{n}), nazwa użytkownika~(\texttt{u}), nazwa grupy~(\texttt{g}), wielkość pliku~(\texttt{s}), liczba zajmowanych bloków pamięci~(\texttt{b}), czas modyfikacji \hreftt{http://leksykot.top.hell.pl/lx3/N/atime_mtime_ctime}{mtime}~(\texttt{m}), czas zmiany \hreftt{http://leksykot.top.hell.pl/lx3/N/atime_mtime_ctime}{ctime}~(\texttt{c})\footnote{\texttt{mtime} to~czas ostatniej zmiany zawartości pliku. \texttt{ctime} to~czas ostatniej zmiany informacji o~pliku (np.~zawartości, uprawnień~itd.). \texttt{atime} to~czas ostatniego dostępu do~pliku. $\texttt{mtime} \leq \texttt{ctime} \leq \texttt{atime}$.}. Dwa ostatnie parametry --- \texttt{md5} i~\texttt{sha1} --- definiują funkcje skrótu jakie zostaną użyte do~obliczenia \emph{hashy} plików znajdujących się w~katalogach z~zastosowaną tą~regułą (w~przykładzie są~to~katalogi \path{/bin}, \path{/sbin} i~\path{/var}). Linie~\ref{line:var-log}, \ref{line:spool} i~\ref{line:var-adm-utmp} zaczynają się znakiem wykrzyknika, co~oznacza, że~te~katalogi mają nie być skanowane przez~AIDE.

AIDE jest dostępny w~wielu repozytoriach oprogramowania różnych dystrybucji \glslink{unix-like-system}{*niksowych}. Pakiet oprogramowania dostępny w~repozytorium Debiana tworzy dodatkowe pliki konfiguracyjne i~skrypt opakowujący \hreftt{https://www.apt-browse.org/browse/debian/jessie/main/all/aide-common/0.16~a2.git20130520-3/file/usr/bin/aide.wrapper}{aide.wrapper}, który uniemożliwia uruchomienie więcej niż~jednej instancji AIDE tworząc plik (\hrefemph{https://unix.stackexchange.com/questions/12815/what-are-pid-and-lock-files-for}{lock file}) \path{/var/run/aide.lock}, za~pomocą skryptu \hreftt{https://www.apt-browse.org/browse/debian/jessie/main/all/aide-common/0.16~a2.git20130520-3/file/usr/sbin/update-aide.conf}{update-aide.conf} scala do~pliku \path{/var/lib/aide/aide.conf.autogenerated} konfigurację AIDE rozproszoną po~plikach \emph{rule files}, umieszczonych w~katalogu \path{/etc/aide.conf.d} oraz~uruchamia właściwy program \hreftt{https://linux.die.net/man/1/aide}{aide}. Instalacja AIDE na~Debianie domyślnie uruchamia AIDE codziennie za~pomocą \hreftt{https://en.wikipedia.org/wiki/Cron}{crona}. Konfiguracja dotycząca działań \texttt{crona} i~AIDE znajduje się w~plikach \path{/etc/default/aide} i~w~\texttt{/etc/cron.daily/aide} (który wywołuje \texttt{aide.wrapper}). Domyślnie baza stworzona ze~skanowania systemu jest tworzona w~pliku \path{/var/lib/aide/aide.db.new}. Logi z~działania AIDE są~domyślnie dostępne w~pliku \path{/var/log/aide/aide.log}. Szczegóły instalacyjne specyficzne dla~Debiana można znaleźć w~pliku \path{/usr/share/doc/aide-common/README.Debian.gz} --- w~szczególności można znaleźć tam wskazówki dotyczące inicjalizacji bazy AIDE za~pomocą skryptu \path{/usr/sbin/aideinit} (\emph{wrapper}) zamiast \texttt{aide~--init}.

%------------------------------------------------------------------------------
%
%\subsection{Generowanie pakietu oprogramowania}
%
%W~celu łatwej instacji powstałego oprogramowania, została przygotowana paczka instalacyjna... TODO

%------------------------------------------------------------------------------
%
%\subsection{Wireshark}
%
%Wireshark jest narzędziem do~analizowania pakietów i~dlatego był jednym z~najczęściej z~używanych narzędzi w~czasie implementacji projektu. Bez Wiresharka podgląd przesyłanych pakietów byłby trudny, szczególnie, że~przesyłane pakiety są~szyfrowane z~wykorzystaniem biblioteki OpenSSL~(patrz rozdział~\ref{sec:security}). Wireshark umożliwia łatwe dekodowanie pakietów po~podaniu klucza prywatnego użytego do~szyfrowania, co~czyni z~niego bardzo wygodne narzędzie do~analizy zaszyfrowanego ruchu sieciowego.

\end{document}
